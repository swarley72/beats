(function () {
const items = document.querySelectorAll(".colors__link");

items.forEach(item => {
  item.addEventListener("click", function(e) {
    e.preventDefault();
    const item = this.closest(".colors__item");
    const container = this.closest(".colors__list");
    const isItemOpened = item.classList.contains("active");
    
    if (isItemOpened) {
      closeAllItems(container);
    } else {
      closeAllItems(container);
      openItem(item);
    }
  })
});

function openItem(item){
  const hiddenDesc = item.querySelector(".colors__desc");
  const textDesc = item.querySelector(".colors__desc-text")
  const width = getWidth(item);
  item.classList.add("active");
  hiddenDesc.style.width = `${width.container}px`;
  textDesc.style.width = `${width.textContainer}px`;
}


function closeAllItems(container) {
  const items = container.querySelectorAll(".colors__item")
  const contentList = container.querySelectorAll(".colors__desc")

  items.forEach(element => {
    element.classList.remove("active")
  });

  contentList.forEach(element => {
    element.style.width = "0px"
  });

}

function getWidth(item) {
  let itemWidth = 0
  const screenWidth = window.innerWidth;
  const container = item.closest(".colors__list");
  const titlesBlocks = container.querySelectorAll(".colors__link");
  const titlesWidth = titlesBlocks[0].offsetWidth * titlesBlocks.length;
  const textContainer = item.querySelector(".colors__desc-text");

  const isTablet = (screenWidth <= 768 && screenWidth > 480);
  const isMobile = screenWidth <= 480;
  
  if(isTablet) {
    itemWidth = screenWidth - titlesWidth;
  } else if (isMobile) {
    itemWidth = screenWidth - titlesBlocks[0].offsetWidth;
  } else {
    itemWidth = 500;
  }

  return {
    container: itemWidth,
    textContainer: itemWidth
  }
}
})();;(function () {
const openBtn = $(".burger");
const closeBtn = $(".fullscreen-menu__close-btn")
const fullScreenMenu = $(".fullscreen-menu");
const menuLink = $(".menu--vertical").find(".menu__item");

openBtn.click(e => {
  fullScreenMenu.css("display", "flex");
  $("body").addClass("body--scroll--lock");
});

closeBtn.click(e => {
  fullScreenMenu.css("display", "none");
  $("body").removeClass("body--scroll--lock");
});

menuLink.click(e => {
  e.preventDefault();
  fullScreenMenu.css("display", "none");
  $("body").removeClass("body--scroll--lock");
  
});
})();;(function () {
let myMap;

function init() {
  myMap = new ymaps.Map("map", {
    center: [55.76, 37.64],
    zoom: 11,
    controls: [

    ]
  });

  const coords = [
    [55.737805, 37.591579],
    [55.720057, 37.630307],
    [55.759343, 37.640231]
  ];

  const myCollection = new ymaps.GeoObjectCollection({}, {
    draggable: true,
    iconLayout: 'default#image',
    iconImageHref: "./img/icons/marker.svg",
    iconImageSize: [50, 73],
    iconImageOffset: []
  });

  coords.forEach(coord => {
    myCollection.add(new ymaps.Placemark(coord));
  })

  myMap.geoObjects.add(myCollection);
  myMap.behaviors.disable("scrollZoom")
}

ymaps.ready(init)

})();;(function () {
function validateForm(form, fieldsArray){
  fieldsArray.forEach(field => {
    field.removeClass("input-error");
    if (field.val().trim() == "") {
      field.addClass("input-error");
    }
  })

  const errorFields = form.find(".input-error");

  return errorFields.length == 0
}


$('.form').submit(e => {
  e.preventDefault();

  const form = $(e.currentTarget);
  const name = form.find("[name='name']");
  const phone = form.find("[name='phone']");
  const comment = form.find("[name='comment']");
  const to = form.find("[name='to']");

  const modal = $(".modal");
  const modalText = modal.find(".modal__text");
  modalText.removeClass('modal__text--error')

  const isValid = validateForm(form, [name, phone, comment, to])

  if (isValid) {
    const request = $.ajax({
      url: "https://webdev-api.loftschool.com/sendmail",
      method: 'post',
      data: {
        name: name.val(),
        phone: phone.val(),
        comment: comment.val(),
        to: to.val(),
      },
    });

    request.done(data => {
      modalText.text(data.message)
    });
    
    request.fail(data => {
      const message = data.responseJSON.message
      modalText.text(message)
      modalText.addClass('modal__text--error')  
    })

    request.always(() => {
      $.fancybox.open({
        src: '#modal',
        type: 'inline'
      })
    })
  }
});


$('.js-modal-button').click(e => {
  e.preventDefault();

  $.fancybox.close();
})
})();;(function () {
const sections = $("section");
const display = $(".maincontent");
const sidemenu = $(".fixed-menu");
const sidemenuItems = sidemenu.find(".fixed-menu__item")
const mobileDetect = new MobileDetect(window.navigator.userAgent);
const isMobile = mobileDetect.mobile();


let inScroll = false;

sections.first().addClass("active");

function countSectionPosition(sectionEq) {
  const position = sectionEq * -100;

  if (isNaN(position)) {
    console.erro("not a number")
    return 0
  }
  return position
}

function changeSidemenuColor(sectionEq) {
  const currentSection = sections.eq(sectionEq);
  const sidemenuColor = currentSection.attr("data-sidemenu-color");

  if (sidemenuColor == "white") {
    sidemenu.addClass("fixed-menu--color--white")
  } else {
    sidemenu.removeClass("fixed-menu--color--white")
  }
}

function resetActiveClassForItem(items, itemEq, activeClass) {
  items.eq(itemEq).addClass(activeClass).siblings().removeClass(activeClass);
}

function performTransition(sectionEq) {
  if (inScroll) return
  const transitionOver = 600;
  const mouseInertionOver = 300;
  inScroll = true;

  const position = countSectionPosition(sectionEq);

  changeSidemenuColor(sectionEq);

  display.css({
    transform: `translateY(${position}%)`
  })

  resetActiveClassForItem(sections, sectionEq, "active")
  
  setTimeout(() => {
    inScroll = false;

    resetActiveClassForItem(sidemenuItems, sectionEq, "fixed-menu__item--active");

  }, transitionOver + mouseInertionOver);
}

function viewportScroller() {
  const activeSection = sections.filter(".active");
  const nextSection = activeSection.next();
  const prevSection = activeSection.prev();

  return {
    next() {
      if (nextSection.length) {
        performTransition(nextSection.index())
      }
    },

    prev() {
      if (prevSection.length) {
      performTransition(prevSection.index())
      }
    }
  }
}

$(window).on("wheel", e => {
  const deltaY = e.originalEvent.deltaY;
  const scroller = viewportScroller();

  if (deltaY > 0) {
    scroller.next()
  }
  
  if (deltaY < 0) {
    scroller.prev()
  }
})

$(window).on("keydown", e => {
  const tagName = e.target.tagName.toLowerCase();
  const userTypingInInputs = tagName == "input" && tagName == "textarea";
  const scroller = viewportScroller();

  if (userTypingInInputs) return

  switch(e.keyCode) {
    case 38: //prev
      scroller.prev();
      break;

    case 40: //next
      scroller.next();
      break;
    }
})

$("[data-scroll-to]").click(e => {
  e.preventDefault();

  const $this = $(e.currentTarget);
  const target = $this.attr("data-scroll-to");
  const reqSection = $(`[data-section-id=${target}]`);

  performTransition(reqSection.index());
})


if (isMobile) {
  $("body").swipe( {
    preventDefaultEvents: false,
    //Generic swipe handler for all directions
    swipe: function(event, direction) {
      const scroller = viewportScroller();
      let scrollDirection = "";
      let isVerticalScroll = false;
      if (direction == "up"){
        scrollDirection = "next";
        isVerticalScroll = true;
      } 
      if (direction == "down"){
        scrollDirection = "prev";
        isVerticalScroll = true;
      } 
      if (isVerticalScroll){
        scroller[scrollDirection]();
      }
  
    }
  });
  
  $(".wrapper").on("touchmove", e => e.preventDefault());

}
})();;(function (){
  const playerContainer = document.querySelector(".player");
  const playerWrapper = document.querySelector(".player__wrapper");
  const video = document.querySelector(".player__video");
  const playerStart = document.querySelector(".player__start");
  const playerPlayback = document.querySelector(".player__playback");
  const progressBar = document.querySelector(".player__playback-line");
  const playerVideoCircle = document.querySelector(".player__playback-button");
  const playerVolumeIcon = document.querySelector(".player__volume-icon-img");
  const playerVolumeBar = document.querySelector(".player__volume");
  const playerVolumeCircle = document.querySelector(".player__volume-button");
  const playerSplash =  document.querySelector(".player__splash");
  const redVolumeBar = document.querySelector(".player__volume-bar");

  let startVolume = 0;
  let currentVolume;


  //play/pause video

  function handlerStart() {
    if (video.paused) {
      video.play()
      playerSplash.style.display = "none"
    } else {
      video.pause()
      playerSplash.style.display = "block"
    }
  }

  playerStart.addEventListener("click", handlerStart);
  playerWrapper.addEventListener("click", handlerStart);


  //toggle play/pause icon
  video.onplay = () => {
    togglePlayer();
  }
  video.onpause = () => {
    togglePlayer("pause");
    
  }

  function togglePlayer(action = "start") {
    if (action == "start") {
      playerContainer.classList.add("player__active")
    } else {
      playerContainer.classList.remove("player__active")

    }
  }

  //volume bar
  function changeVolume(elem) {
  // const (currentTarget) = elem;
    const currentTarget = elem.currentTarget;

    const left = currentTarget.getBoundingClientRect().left;
    const soundBarWIdth = parseInt(getComputedStyle(currentTarget).width);
    const newPosition = elem.pageX - left;
    const percentValue = (newPosition / soundBarWIdth) * 100;
    const circleWidth = parseInt(getComputedStyle(playerVolumeCircle).width)

    video.volume = percentValue / 100;
    playerVolumeCircle.style.left = `${percentValue}%`;
    redVolumeBar.style.width = `${percentValue - circleWidth}%`;
  }

  function toggleSound() {
    playerVolumeIcon.classList.toggle("muted")
    
    const redVolumeBar = document.querySelector(".player__volume-bar");
    if (video.volume == 0) {
      video.volume = currentVolume;
      playerVolumeCircle.style.left = `${currentVolume * 100}%`
      redVolumeBar.style.width = `${currentVolume * 100}%`
      
    } else {
      currentVolume = video.volume;
      video.volume = startVolume;
      playerVolumeCircle.style.left = `${startVolume}%`
      redVolumeBar.style.width = `${startVolume}%`
    }
  }

  playerVolumeBar.addEventListener("click", changeVolume);
  playerVolumeIcon.addEventListener("click", toggleSound);


  //video 

  function handleDuration(e) {
    const barSize = parseInt(getComputedStyle(playerPlayback).width);
    const circleWidth = parseInt(getComputedStyle(playerVideoCircle).width);
    const offsetX = e.offsetX;
    const newSize = offsetX + circleWidth / 2;
    const newTime = (newSize * video.duration) / barSize;
    video.currentTime = newTime;
  }

  function updateTime() {
    let redBar = video.currentTime / video.duration;
    progressBar.style.width = `${redBar * 100}%`

    if (video.ended) {
      video.currentTime = 0;
    }
  }

  playerPlayback.addEventListener("click", handleDuration);
  video.addEventListener("timeupdate", updateTime);


})();;(function () {
function getBlockByAlias(alias){
  return $(".reviews__item").filter((index, item) => {
    return $(item).attr("data-linked-with") == alias
  });
}

$(".interactive-avatar__link").on("click", e => {
  e.preventDefault();

  const $this = $(e.currentTarget);
  const target = $this.attr("data-open");
  const itemToShow = getBlockByAlias(target);
  const currentItem = $this.closest(".interactive-avatar");

  itemToShow.addClass("active").siblings().removeClass("active")
  currentItem.addClass("active").siblings().removeClass("active")
})
})();;let bxSliderOptions;
if (window.innerWidth >= 768) {
  bxSliderOptions = {
  pager: false,
  controls: false,
  touchEnabled: false
}} else {
  bxSliderOptions = {
  pager: false,
  controls: false,
}}
  
const slider = $('.slider__list').bxSlider(bxSliderOptions);

$(".slider__arrow--type--prev").click(e => {
  e.preventDefault();
  slider.goToPrevSlide();
});

$(".slider__arrow--type--next").click(e => {
  e.preventDefault();
  slider.goToNextSlide();
});;(function () {
const employeeListDesk = $(".team__name", ".team__list--desktop");

const employeeListMobile = $(".team__name", ".team__list--mobile");

function hideAccordeon(employeeList){
  employeeList.each((index, employee) => {
    let descElem = $(employee).next();
    descElem.height(0);
    descElem.removeClass("active");
    $(employee).removeClass("team__name--active");
  });
}

function showAccordeon(descWrapElem, nameElem){
  let descElem = descWrapElem.find('.team__desc');
  let height = descElem.css('height');
  descWrapElem.height(height);
  nameElem.addClass("team__name--active")
  descWrapElem.addClass("active");
}

function isDesktop(elem) {
  return elem.closest(".team__list--desktop").length == 1;
};

$(".team__name").on("click", function (){
  let currentName = $(this);
  let desc = currentName.next();

  if (desc.hasClass("active")) {
    if (isDesktop(currentName)){
      hideAccordeon(employeeListDesk);
    } else {
      hideAccordeon(employeeListMobile);
    }
  } else {
    if (isDesktop(currentName)){
      hideAccordeon(employeeListDesk)
    } else {
      hideAccordeon(employeeListMobile)
    }
    showAccordeon(desc, currentName)
  }

});
})();

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbG9ycy5qcyIsImZ1bGxzY3JlZW4tbWVudS5qcyIsIm1hcC5qcyIsIm1vZGFsLmpzIiwib3BzLmpzIiwicGxheWVyLmpzIiwicmV2aWV3cy5qcyIsInNsaWRlci5qcyIsInRlYW0uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQ25FQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1DdEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1DcENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUNuRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUN0SkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1DakhBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1DbEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUN0QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6Im1haW4ubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uICgpIHtcbmNvbnN0IGl0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5jb2xvcnNfX2xpbmtcIik7XG5cbml0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGZ1bmN0aW9uKGUpIHtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgY29uc3QgaXRlbSA9IHRoaXMuY2xvc2VzdChcIi5jb2xvcnNfX2l0ZW1cIik7XG4gICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jbG9zZXN0KFwiLmNvbG9yc19fbGlzdFwiKTtcbiAgICBjb25zdCBpc0l0ZW1PcGVuZWQgPSBpdGVtLmNsYXNzTGlzdC5jb250YWlucyhcImFjdGl2ZVwiKTtcbiAgICBcbiAgICBpZiAoaXNJdGVtT3BlbmVkKSB7XG4gICAgICBjbG9zZUFsbEl0ZW1zKGNvbnRhaW5lcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNsb3NlQWxsSXRlbXMoY29udGFpbmVyKTtcbiAgICAgIG9wZW5JdGVtKGl0ZW0pO1xuICAgIH1cbiAgfSlcbn0pO1xuXG5mdW5jdGlvbiBvcGVuSXRlbShpdGVtKXtcbiAgY29uc3QgaGlkZGVuRGVzYyA9IGl0ZW0ucXVlcnlTZWxlY3RvcihcIi5jb2xvcnNfX2Rlc2NcIik7XG4gIGNvbnN0IHRleHREZXNjID0gaXRlbS5xdWVyeVNlbGVjdG9yKFwiLmNvbG9yc19fZGVzYy10ZXh0XCIpXG4gIGNvbnN0IHdpZHRoID0gZ2V0V2lkdGgoaXRlbSk7XG4gIGl0ZW0uY2xhc3NMaXN0LmFkZChcImFjdGl2ZVwiKTtcbiAgaGlkZGVuRGVzYy5zdHlsZS53aWR0aCA9IGAke3dpZHRoLmNvbnRhaW5lcn1weGA7XG4gIHRleHREZXNjLnN0eWxlLndpZHRoID0gYCR7d2lkdGgudGV4dENvbnRhaW5lcn1weGA7XG59XG5cblxuZnVuY3Rpb24gY2xvc2VBbGxJdGVtcyhjb250YWluZXIpIHtcbiAgY29uc3QgaXRlbXMgPSBjb250YWluZXIucXVlcnlTZWxlY3RvckFsbChcIi5jb2xvcnNfX2l0ZW1cIilcbiAgY29uc3QgY29udGVudExpc3QgPSBjb250YWluZXIucXVlcnlTZWxlY3RvckFsbChcIi5jb2xvcnNfX2Rlc2NcIilcblxuICBpdGVtcy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgIGVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZShcImFjdGl2ZVwiKVxuICB9KTtcblxuICBjb250ZW50TGlzdC5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgIGVsZW1lbnQuc3R5bGUud2lkdGggPSBcIjBweFwiXG4gIH0pO1xuXG59XG5cbmZ1bmN0aW9uIGdldFdpZHRoKGl0ZW0pIHtcbiAgbGV0IGl0ZW1XaWR0aCA9IDBcbiAgY29uc3Qgc2NyZWVuV2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgY29uc3QgY29udGFpbmVyID0gaXRlbS5jbG9zZXN0KFwiLmNvbG9yc19fbGlzdFwiKTtcbiAgY29uc3QgdGl0bGVzQmxvY2tzID0gY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3JBbGwoXCIuY29sb3JzX19saW5rXCIpO1xuICBjb25zdCB0aXRsZXNXaWR0aCA9IHRpdGxlc0Jsb2Nrc1swXS5vZmZzZXRXaWR0aCAqIHRpdGxlc0Jsb2Nrcy5sZW5ndGg7XG4gIGNvbnN0IHRleHRDb250YWluZXIgPSBpdGVtLnF1ZXJ5U2VsZWN0b3IoXCIuY29sb3JzX19kZXNjLXRleHRcIik7XG5cbiAgY29uc3QgaXNUYWJsZXQgPSAoc2NyZWVuV2lkdGggPD0gNzY4ICYmIHNjcmVlbldpZHRoID4gNDgwKTtcbiAgY29uc3QgaXNNb2JpbGUgPSBzY3JlZW5XaWR0aCA8PSA0ODA7XG4gIFxuICBpZihpc1RhYmxldCkge1xuICAgIGl0ZW1XaWR0aCA9IHNjcmVlbldpZHRoIC0gdGl0bGVzV2lkdGg7XG4gIH0gZWxzZSBpZiAoaXNNb2JpbGUpIHtcbiAgICBpdGVtV2lkdGggPSBzY3JlZW5XaWR0aCAtIHRpdGxlc0Jsb2Nrc1swXS5vZmZzZXRXaWR0aDtcbiAgfSBlbHNlIHtcbiAgICBpdGVtV2lkdGggPSA1MDA7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGNvbnRhaW5lcjogaXRlbVdpZHRoLFxuICAgIHRleHRDb250YWluZXI6IGl0ZW1XaWR0aFxuICB9XG59XG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XG5jb25zdCBvcGVuQnRuID0gJChcIi5idXJnZXJcIik7XG5jb25zdCBjbG9zZUJ0biA9ICQoXCIuZnVsbHNjcmVlbi1tZW51X19jbG9zZS1idG5cIilcbmNvbnN0IGZ1bGxTY3JlZW5NZW51ID0gJChcIi5mdWxsc2NyZWVuLW1lbnVcIik7XG5jb25zdCBtZW51TGluayA9ICQoXCIubWVudS0tdmVydGljYWxcIikuZmluZChcIi5tZW51X19pdGVtXCIpO1xuXG5vcGVuQnRuLmNsaWNrKGUgPT4ge1xuICBmdWxsU2NyZWVuTWVudS5jc3MoXCJkaXNwbGF5XCIsIFwiZmxleFwiKTtcbiAgJChcImJvZHlcIikuYWRkQ2xhc3MoXCJib2R5LS1zY3JvbGwtLWxvY2tcIik7XG59KTtcblxuY2xvc2VCdG4uY2xpY2soZSA9PiB7XG4gIGZ1bGxTY3JlZW5NZW51LmNzcyhcImRpc3BsYXlcIiwgXCJub25lXCIpO1xuICAkKFwiYm9keVwiKS5yZW1vdmVDbGFzcyhcImJvZHktLXNjcm9sbC0tbG9ja1wiKTtcbn0pO1xuXG5tZW51TGluay5jbGljayhlID0+IHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICBmdWxsU2NyZWVuTWVudS5jc3MoXCJkaXNwbGF5XCIsIFwibm9uZVwiKTtcbiAgJChcImJvZHlcIikucmVtb3ZlQ2xhc3MoXCJib2R5LS1zY3JvbGwtLWxvY2tcIik7XG4gIFxufSk7XG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XG5sZXQgbXlNYXA7XG5cbmZ1bmN0aW9uIGluaXQoKSB7XG4gIG15TWFwID0gbmV3IHltYXBzLk1hcChcIm1hcFwiLCB7XG4gICAgY2VudGVyOiBbNTUuNzYsIDM3LjY0XSxcbiAgICB6b29tOiAxMSxcbiAgICBjb250cm9sczogW1xuXG4gICAgXVxuICB9KTtcblxuICBjb25zdCBjb29yZHMgPSBbXG4gICAgWzU1LjczNzgwNSwgMzcuNTkxNTc5XSxcbiAgICBbNTUuNzIwMDU3LCAzNy42MzAzMDddLFxuICAgIFs1NS43NTkzNDMsIDM3LjY0MDIzMV1cbiAgXTtcblxuICBjb25zdCBteUNvbGxlY3Rpb24gPSBuZXcgeW1hcHMuR2VvT2JqZWN0Q29sbGVjdGlvbih7fSwge1xuICAgIGRyYWdnYWJsZTogdHJ1ZSxcbiAgICBpY29uTGF5b3V0OiAnZGVmYXVsdCNpbWFnZScsXG4gICAgaWNvbkltYWdlSHJlZjogXCIuL2ltZy9pY29ucy9tYXJrZXIuc3ZnXCIsXG4gICAgaWNvbkltYWdlU2l6ZTogWzUwLCA3M10sXG4gICAgaWNvbkltYWdlT2Zmc2V0OiBbXVxuICB9KTtcblxuICBjb29yZHMuZm9yRWFjaChjb29yZCA9PiB7XG4gICAgbXlDb2xsZWN0aW9uLmFkZChuZXcgeW1hcHMuUGxhY2VtYXJrKGNvb3JkKSk7XG4gIH0pXG5cbiAgbXlNYXAuZ2VvT2JqZWN0cy5hZGQobXlDb2xsZWN0aW9uKTtcbiAgbXlNYXAuYmVoYXZpb3JzLmRpc2FibGUoXCJzY3JvbGxab29tXCIpXG59XG5cbnltYXBzLnJlYWR5KGluaXQpXG5cbn0pKCk7IiwiKGZ1bmN0aW9uICgpIHtcbmZ1bmN0aW9uIHZhbGlkYXRlRm9ybShmb3JtLCBmaWVsZHNBcnJheSl7XG4gIGZpZWxkc0FycmF5LmZvckVhY2goZmllbGQgPT4ge1xuICAgIGZpZWxkLnJlbW92ZUNsYXNzKFwiaW5wdXQtZXJyb3JcIik7XG4gICAgaWYgKGZpZWxkLnZhbCgpLnRyaW0oKSA9PSBcIlwiKSB7XG4gICAgICBmaWVsZC5hZGRDbGFzcyhcImlucHV0LWVycm9yXCIpO1xuICAgIH1cbiAgfSlcblxuICBjb25zdCBlcnJvckZpZWxkcyA9IGZvcm0uZmluZChcIi5pbnB1dC1lcnJvclwiKTtcblxuICByZXR1cm4gZXJyb3JGaWVsZHMubGVuZ3RoID09IDBcbn1cblxuXG4kKCcuZm9ybScpLnN1Ym1pdChlID0+IHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gIGNvbnN0IGZvcm0gPSAkKGUuY3VycmVudFRhcmdldCk7XG4gIGNvbnN0IG5hbWUgPSBmb3JtLmZpbmQoXCJbbmFtZT0nbmFtZSddXCIpO1xuICBjb25zdCBwaG9uZSA9IGZvcm0uZmluZChcIltuYW1lPSdwaG9uZSddXCIpO1xuICBjb25zdCBjb21tZW50ID0gZm9ybS5maW5kKFwiW25hbWU9J2NvbW1lbnQnXVwiKTtcbiAgY29uc3QgdG8gPSBmb3JtLmZpbmQoXCJbbmFtZT0ndG8nXVwiKTtcblxuICBjb25zdCBtb2RhbCA9ICQoXCIubW9kYWxcIik7XG4gIGNvbnN0IG1vZGFsVGV4dCA9IG1vZGFsLmZpbmQoXCIubW9kYWxfX3RleHRcIik7XG4gIG1vZGFsVGV4dC5yZW1vdmVDbGFzcygnbW9kYWxfX3RleHQtLWVycm9yJylcblxuICBjb25zdCBpc1ZhbGlkID0gdmFsaWRhdGVGb3JtKGZvcm0sIFtuYW1lLCBwaG9uZSwgY29tbWVudCwgdG9dKVxuXG4gIGlmIChpc1ZhbGlkKSB7XG4gICAgY29uc3QgcmVxdWVzdCA9ICQuYWpheCh7XG4gICAgICB1cmw6IFwiaHR0cHM6Ly93ZWJkZXYtYXBpLmxvZnRzY2hvb2wuY29tL3NlbmRtYWlsXCIsXG4gICAgICBtZXRob2Q6ICdwb3N0JyxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgbmFtZTogbmFtZS52YWwoKSxcbiAgICAgICAgcGhvbmU6IHBob25lLnZhbCgpLFxuICAgICAgICBjb21tZW50OiBjb21tZW50LnZhbCgpLFxuICAgICAgICB0bzogdG8udmFsKCksXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmVxdWVzdC5kb25lKGRhdGEgPT4ge1xuICAgICAgbW9kYWxUZXh0LnRleHQoZGF0YS5tZXNzYWdlKVxuICAgIH0pO1xuICAgIFxuICAgIHJlcXVlc3QuZmFpbChkYXRhID0+IHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBkYXRhLnJlc3BvbnNlSlNPTi5tZXNzYWdlXG4gICAgICBtb2RhbFRleHQudGV4dChtZXNzYWdlKVxuICAgICAgbW9kYWxUZXh0LmFkZENsYXNzKCdtb2RhbF9fdGV4dC0tZXJyb3InKSAgXG4gICAgfSlcblxuICAgIHJlcXVlc3QuYWx3YXlzKCgpID0+IHtcbiAgICAgICQuZmFuY3lib3gub3Blbih7XG4gICAgICAgIHNyYzogJyNtb2RhbCcsXG4gICAgICAgIHR5cGU6ICdpbmxpbmUnXG4gICAgICB9KVxuICAgIH0pXG4gIH1cbn0pO1xuXG5cbiQoJy5qcy1tb2RhbC1idXR0b24nKS5jbGljayhlID0+IHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICQuZmFuY3lib3guY2xvc2UoKTtcbn0pXG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XG5jb25zdCBzZWN0aW9ucyA9ICQoXCJzZWN0aW9uXCIpO1xuY29uc3QgZGlzcGxheSA9ICQoXCIubWFpbmNvbnRlbnRcIik7XG5jb25zdCBzaWRlbWVudSA9ICQoXCIuZml4ZWQtbWVudVwiKTtcbmNvbnN0IHNpZGVtZW51SXRlbXMgPSBzaWRlbWVudS5maW5kKFwiLmZpeGVkLW1lbnVfX2l0ZW1cIilcbmNvbnN0IG1vYmlsZURldGVjdCA9IG5ldyBNb2JpbGVEZXRlY3Qod2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpO1xuY29uc3QgaXNNb2JpbGUgPSBtb2JpbGVEZXRlY3QubW9iaWxlKCk7XG5cblxubGV0IGluU2Nyb2xsID0gZmFsc2U7XG5cbnNlY3Rpb25zLmZpcnN0KCkuYWRkQ2xhc3MoXCJhY3RpdmVcIik7XG5cbmZ1bmN0aW9uIGNvdW50U2VjdGlvblBvc2l0aW9uKHNlY3Rpb25FcSkge1xuICBjb25zdCBwb3NpdGlvbiA9IHNlY3Rpb25FcSAqIC0xMDA7XG5cbiAgaWYgKGlzTmFOKHBvc2l0aW9uKSkge1xuICAgIGNvbnNvbGUuZXJybyhcIm5vdCBhIG51bWJlclwiKVxuICAgIHJldHVybiAwXG4gIH1cbiAgcmV0dXJuIHBvc2l0aW9uXG59XG5cbmZ1bmN0aW9uIGNoYW5nZVNpZGVtZW51Q29sb3Ioc2VjdGlvbkVxKSB7XG4gIGNvbnN0IGN1cnJlbnRTZWN0aW9uID0gc2VjdGlvbnMuZXEoc2VjdGlvbkVxKTtcbiAgY29uc3Qgc2lkZW1lbnVDb2xvciA9IGN1cnJlbnRTZWN0aW9uLmF0dHIoXCJkYXRhLXNpZGVtZW51LWNvbG9yXCIpO1xuXG4gIGlmIChzaWRlbWVudUNvbG9yID09IFwid2hpdGVcIikge1xuICAgIHNpZGVtZW51LmFkZENsYXNzKFwiZml4ZWQtbWVudS0tY29sb3ItLXdoaXRlXCIpXG4gIH0gZWxzZSB7XG4gICAgc2lkZW1lbnUucmVtb3ZlQ2xhc3MoXCJmaXhlZC1tZW51LS1jb2xvci0td2hpdGVcIilcbiAgfVxufVxuXG5mdW5jdGlvbiByZXNldEFjdGl2ZUNsYXNzRm9ySXRlbShpdGVtcywgaXRlbUVxLCBhY3RpdmVDbGFzcykge1xuICBpdGVtcy5lcShpdGVtRXEpLmFkZENsYXNzKGFjdGl2ZUNsYXNzKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKGFjdGl2ZUNsYXNzKTtcbn1cblxuZnVuY3Rpb24gcGVyZm9ybVRyYW5zaXRpb24oc2VjdGlvbkVxKSB7XG4gIGlmIChpblNjcm9sbCkgcmV0dXJuXG4gIGNvbnN0IHRyYW5zaXRpb25PdmVyID0gNjAwO1xuICBjb25zdCBtb3VzZUluZXJ0aW9uT3ZlciA9IDMwMDtcbiAgaW5TY3JvbGwgPSB0cnVlO1xuXG4gIGNvbnN0IHBvc2l0aW9uID0gY291bnRTZWN0aW9uUG9zaXRpb24oc2VjdGlvbkVxKTtcblxuICBjaGFuZ2VTaWRlbWVudUNvbG9yKHNlY3Rpb25FcSk7XG5cbiAgZGlzcGxheS5jc3Moe1xuICAgIHRyYW5zZm9ybTogYHRyYW5zbGF0ZVkoJHtwb3NpdGlvbn0lKWBcbiAgfSlcblxuICByZXNldEFjdGl2ZUNsYXNzRm9ySXRlbShzZWN0aW9ucywgc2VjdGlvbkVxLCBcImFjdGl2ZVwiKVxuICBcbiAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgaW5TY3JvbGwgPSBmYWxzZTtcblxuICAgIHJlc2V0QWN0aXZlQ2xhc3NGb3JJdGVtKHNpZGVtZW51SXRlbXMsIHNlY3Rpb25FcSwgXCJmaXhlZC1tZW51X19pdGVtLS1hY3RpdmVcIik7XG5cbiAgfSwgdHJhbnNpdGlvbk92ZXIgKyBtb3VzZUluZXJ0aW9uT3Zlcik7XG59XG5cbmZ1bmN0aW9uIHZpZXdwb3J0U2Nyb2xsZXIoKSB7XG4gIGNvbnN0IGFjdGl2ZVNlY3Rpb24gPSBzZWN0aW9ucy5maWx0ZXIoXCIuYWN0aXZlXCIpO1xuICBjb25zdCBuZXh0U2VjdGlvbiA9IGFjdGl2ZVNlY3Rpb24ubmV4dCgpO1xuICBjb25zdCBwcmV2U2VjdGlvbiA9IGFjdGl2ZVNlY3Rpb24ucHJldigpO1xuXG4gIHJldHVybiB7XG4gICAgbmV4dCgpIHtcbiAgICAgIGlmIChuZXh0U2VjdGlvbi5sZW5ndGgpIHtcbiAgICAgICAgcGVyZm9ybVRyYW5zaXRpb24obmV4dFNlY3Rpb24uaW5kZXgoKSlcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgcHJldigpIHtcbiAgICAgIGlmIChwcmV2U2VjdGlvbi5sZW5ndGgpIHtcbiAgICAgIHBlcmZvcm1UcmFuc2l0aW9uKHByZXZTZWN0aW9uLmluZGV4KCkpXG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbiQod2luZG93KS5vbihcIndoZWVsXCIsIGUgPT4ge1xuICBjb25zdCBkZWx0YVkgPSBlLm9yaWdpbmFsRXZlbnQuZGVsdGFZO1xuICBjb25zdCBzY3JvbGxlciA9IHZpZXdwb3J0U2Nyb2xsZXIoKTtcblxuICBpZiAoZGVsdGFZID4gMCkge1xuICAgIHNjcm9sbGVyLm5leHQoKVxuICB9XG4gIFxuICBpZiAoZGVsdGFZIDwgMCkge1xuICAgIHNjcm9sbGVyLnByZXYoKVxuICB9XG59KVxuXG4kKHdpbmRvdykub24oXCJrZXlkb3duXCIsIGUgPT4ge1xuICBjb25zdCB0YWdOYW1lID0gZS50YXJnZXQudGFnTmFtZS50b0xvd2VyQ2FzZSgpO1xuICBjb25zdCB1c2VyVHlwaW5nSW5JbnB1dHMgPSB0YWdOYW1lID09IFwiaW5wdXRcIiAmJiB0YWdOYW1lID09IFwidGV4dGFyZWFcIjtcbiAgY29uc3Qgc2Nyb2xsZXIgPSB2aWV3cG9ydFNjcm9sbGVyKCk7XG5cbiAgaWYgKHVzZXJUeXBpbmdJbklucHV0cykgcmV0dXJuXG5cbiAgc3dpdGNoKGUua2V5Q29kZSkge1xuICAgIGNhc2UgMzg6IC8vcHJldlxuICAgICAgc2Nyb2xsZXIucHJldigpO1xuICAgICAgYnJlYWs7XG5cbiAgICBjYXNlIDQwOiAvL25leHRcbiAgICAgIHNjcm9sbGVyLm5leHQoKTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbn0pXG5cbiQoXCJbZGF0YS1zY3JvbGwtdG9dXCIpLmNsaWNrKGUgPT4ge1xuICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgY29uc3QgJHRoaXMgPSAkKGUuY3VycmVudFRhcmdldCk7XG4gIGNvbnN0IHRhcmdldCA9ICR0aGlzLmF0dHIoXCJkYXRhLXNjcm9sbC10b1wiKTtcbiAgY29uc3QgcmVxU2VjdGlvbiA9ICQoYFtkYXRhLXNlY3Rpb24taWQ9JHt0YXJnZXR9XWApO1xuXG4gIHBlcmZvcm1UcmFuc2l0aW9uKHJlcVNlY3Rpb24uaW5kZXgoKSk7XG59KVxuXG5cbmlmIChpc01vYmlsZSkge1xuICAkKFwiYm9keVwiKS5zd2lwZSgge1xuICAgIHByZXZlbnREZWZhdWx0RXZlbnRzOiBmYWxzZSxcbiAgICAvL0dlbmVyaWMgc3dpcGUgaGFuZGxlciBmb3IgYWxsIGRpcmVjdGlvbnNcbiAgICBzd2lwZTogZnVuY3Rpb24oZXZlbnQsIGRpcmVjdGlvbikge1xuICAgICAgY29uc3Qgc2Nyb2xsZXIgPSB2aWV3cG9ydFNjcm9sbGVyKCk7XG4gICAgICBsZXQgc2Nyb2xsRGlyZWN0aW9uID0gXCJcIjtcbiAgICAgIGxldCBpc1ZlcnRpY2FsU2Nyb2xsID0gZmFsc2U7XG4gICAgICBpZiAoZGlyZWN0aW9uID09IFwidXBcIil7XG4gICAgICAgIHNjcm9sbERpcmVjdGlvbiA9IFwibmV4dFwiO1xuICAgICAgICBpc1ZlcnRpY2FsU2Nyb2xsID0gdHJ1ZTtcbiAgICAgIH0gXG4gICAgICBpZiAoZGlyZWN0aW9uID09IFwiZG93blwiKXtcbiAgICAgICAgc2Nyb2xsRGlyZWN0aW9uID0gXCJwcmV2XCI7XG4gICAgICAgIGlzVmVydGljYWxTY3JvbGwgPSB0cnVlO1xuICAgICAgfSBcbiAgICAgIGlmIChpc1ZlcnRpY2FsU2Nyb2xsKXtcbiAgICAgICAgc2Nyb2xsZXJbc2Nyb2xsRGlyZWN0aW9uXSgpO1xuICAgICAgfVxuICBcbiAgICB9XG4gIH0pO1xuICBcbiAgJChcIi53cmFwcGVyXCIpLm9uKFwidG91Y2htb3ZlXCIsIGUgPT4gZS5wcmV2ZW50RGVmYXVsdCgpKTtcblxufVxufSkoKTsiLCIoZnVuY3Rpb24gKCl7XG4gIGNvbnN0IHBsYXllckNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucGxheWVyXCIpO1xuICBjb25zdCBwbGF5ZXJXcmFwcGVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5wbGF5ZXJfX3dyYXBwZXJcIik7XG4gIGNvbnN0IHZpZGVvID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5wbGF5ZXJfX3ZpZGVvXCIpO1xuICBjb25zdCBwbGF5ZXJTdGFydCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucGxheWVyX19zdGFydFwiKTtcbiAgY29uc3QgcGxheWVyUGxheWJhY2sgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLnBsYXllcl9fcGxheWJhY2tcIik7XG4gIGNvbnN0IHByb2dyZXNzQmFyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5wbGF5ZXJfX3BsYXliYWNrLWxpbmVcIik7XG4gIGNvbnN0IHBsYXllclZpZGVvQ2lyY2xlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5wbGF5ZXJfX3BsYXliYWNrLWJ1dHRvblwiKTtcbiAgY29uc3QgcGxheWVyVm9sdW1lSWNvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucGxheWVyX192b2x1bWUtaWNvbi1pbWdcIik7XG4gIGNvbnN0IHBsYXllclZvbHVtZUJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucGxheWVyX192b2x1bWVcIik7XG4gIGNvbnN0IHBsYXllclZvbHVtZUNpcmNsZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucGxheWVyX192b2x1bWUtYnV0dG9uXCIpO1xuICBjb25zdCBwbGF5ZXJTcGxhc2ggPSAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5wbGF5ZXJfX3NwbGFzaFwiKTtcbiAgY29uc3QgcmVkVm9sdW1lQmFyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5wbGF5ZXJfX3ZvbHVtZS1iYXJcIik7XG5cbiAgbGV0IHN0YXJ0Vm9sdW1lID0gMDtcbiAgbGV0IGN1cnJlbnRWb2x1bWU7XG5cblxuICAvL3BsYXkvcGF1c2UgdmlkZW9cblxuICBmdW5jdGlvbiBoYW5kbGVyU3RhcnQoKSB7XG4gICAgaWYgKHZpZGVvLnBhdXNlZCkge1xuICAgICAgdmlkZW8ucGxheSgpXG4gICAgICBwbGF5ZXJTcGxhc2guc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiXG4gICAgfSBlbHNlIHtcbiAgICAgIHZpZGVvLnBhdXNlKClcbiAgICAgIHBsYXllclNwbGFzaC5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiXG4gICAgfVxuICB9XG5cbiAgcGxheWVyU3RhcnQuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGhhbmRsZXJTdGFydCk7XG4gIHBsYXllcldyYXBwZXIuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGhhbmRsZXJTdGFydCk7XG5cblxuICAvL3RvZ2dsZSBwbGF5L3BhdXNlIGljb25cbiAgdmlkZW8ub25wbGF5ID0gKCkgPT4ge1xuICAgIHRvZ2dsZVBsYXllcigpO1xuICB9XG4gIHZpZGVvLm9ucGF1c2UgPSAoKSA9PiB7XG4gICAgdG9nZ2xlUGxheWVyKFwicGF1c2VcIik7XG4gICAgXG4gIH1cblxuICBmdW5jdGlvbiB0b2dnbGVQbGF5ZXIoYWN0aW9uID0gXCJzdGFydFwiKSB7XG4gICAgaWYgKGFjdGlvbiA9PSBcInN0YXJ0XCIpIHtcbiAgICAgIHBsYXllckNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKFwicGxheWVyX19hY3RpdmVcIilcbiAgICB9IGVsc2Uge1xuICAgICAgcGxheWVyQ29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoXCJwbGF5ZXJfX2FjdGl2ZVwiKVxuXG4gICAgfVxuICB9XG5cbiAgLy92b2x1bWUgYmFyXG4gIGZ1bmN0aW9uIGNoYW5nZVZvbHVtZShlbGVtKSB7XG4gIC8vIGNvbnN0IChjdXJyZW50VGFyZ2V0KSA9IGVsZW07XG4gICAgY29uc3QgY3VycmVudFRhcmdldCA9IGVsZW0uY3VycmVudFRhcmdldDtcblxuICAgIGNvbnN0IGxlZnQgPSBjdXJyZW50VGFyZ2V0LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQ7XG4gICAgY29uc3Qgc291bmRCYXJXSWR0aCA9IHBhcnNlSW50KGdldENvbXB1dGVkU3R5bGUoY3VycmVudFRhcmdldCkud2lkdGgpO1xuICAgIGNvbnN0IG5ld1Bvc2l0aW9uID0gZWxlbS5wYWdlWCAtIGxlZnQ7XG4gICAgY29uc3QgcGVyY2VudFZhbHVlID0gKG5ld1Bvc2l0aW9uIC8gc291bmRCYXJXSWR0aCkgKiAxMDA7XG4gICAgY29uc3QgY2lyY2xlV2lkdGggPSBwYXJzZUludChnZXRDb21wdXRlZFN0eWxlKHBsYXllclZvbHVtZUNpcmNsZSkud2lkdGgpXG5cbiAgICB2aWRlby52b2x1bWUgPSBwZXJjZW50VmFsdWUgLyAxMDA7XG4gICAgcGxheWVyVm9sdW1lQ2lyY2xlLnN0eWxlLmxlZnQgPSBgJHtwZXJjZW50VmFsdWV9JWA7XG4gICAgcmVkVm9sdW1lQmFyLnN0eWxlLndpZHRoID0gYCR7cGVyY2VudFZhbHVlIC0gY2lyY2xlV2lkdGh9JWA7XG4gIH1cblxuICBmdW5jdGlvbiB0b2dnbGVTb3VuZCgpIHtcbiAgICBwbGF5ZXJWb2x1bWVJY29uLmNsYXNzTGlzdC50b2dnbGUoXCJtdXRlZFwiKVxuICAgIFxuICAgIGNvbnN0IHJlZFZvbHVtZUJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucGxheWVyX192b2x1bWUtYmFyXCIpO1xuICAgIGlmICh2aWRlby52b2x1bWUgPT0gMCkge1xuICAgICAgdmlkZW8udm9sdW1lID0gY3VycmVudFZvbHVtZTtcbiAgICAgIHBsYXllclZvbHVtZUNpcmNsZS5zdHlsZS5sZWZ0ID0gYCR7Y3VycmVudFZvbHVtZSAqIDEwMH0lYFxuICAgICAgcmVkVm9sdW1lQmFyLnN0eWxlLndpZHRoID0gYCR7Y3VycmVudFZvbHVtZSAqIDEwMH0lYFxuICAgICAgXG4gICAgfSBlbHNlIHtcbiAgICAgIGN1cnJlbnRWb2x1bWUgPSB2aWRlby52b2x1bWU7XG4gICAgICB2aWRlby52b2x1bWUgPSBzdGFydFZvbHVtZTtcbiAgICAgIHBsYXllclZvbHVtZUNpcmNsZS5zdHlsZS5sZWZ0ID0gYCR7c3RhcnRWb2x1bWV9JWBcbiAgICAgIHJlZFZvbHVtZUJhci5zdHlsZS53aWR0aCA9IGAke3N0YXJ0Vm9sdW1lfSVgXG4gICAgfVxuICB9XG5cbiAgcGxheWVyVm9sdW1lQmFyLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBjaGFuZ2VWb2x1bWUpO1xuICBwbGF5ZXJWb2x1bWVJY29uLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCB0b2dnbGVTb3VuZCk7XG5cblxuICAvL3ZpZGVvIFxuXG4gIGZ1bmN0aW9uIGhhbmRsZUR1cmF0aW9uKGUpIHtcbiAgICBjb25zdCBiYXJTaXplID0gcGFyc2VJbnQoZ2V0Q29tcHV0ZWRTdHlsZShwbGF5ZXJQbGF5YmFjaykud2lkdGgpO1xuICAgIGNvbnN0IGNpcmNsZVdpZHRoID0gcGFyc2VJbnQoZ2V0Q29tcHV0ZWRTdHlsZShwbGF5ZXJWaWRlb0NpcmNsZSkud2lkdGgpO1xuICAgIGNvbnN0IG9mZnNldFggPSBlLm9mZnNldFg7XG4gICAgY29uc3QgbmV3U2l6ZSA9IG9mZnNldFggKyBjaXJjbGVXaWR0aCAvIDI7XG4gICAgY29uc3QgbmV3VGltZSA9IChuZXdTaXplICogdmlkZW8uZHVyYXRpb24pIC8gYmFyU2l6ZTtcbiAgICB2aWRlby5jdXJyZW50VGltZSA9IG5ld1RpbWU7XG4gIH1cblxuICBmdW5jdGlvbiB1cGRhdGVUaW1lKCkge1xuICAgIGxldCByZWRCYXIgPSB2aWRlby5jdXJyZW50VGltZSAvIHZpZGVvLmR1cmF0aW9uO1xuICAgIHByb2dyZXNzQmFyLnN0eWxlLndpZHRoID0gYCR7cmVkQmFyICogMTAwfSVgXG5cbiAgICBpZiAodmlkZW8uZW5kZWQpIHtcbiAgICAgIHZpZGVvLmN1cnJlbnRUaW1lID0gMDtcbiAgICB9XG4gIH1cblxuICBwbGF5ZXJQbGF5YmFjay5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgaGFuZGxlRHVyYXRpb24pO1xuICB2aWRlby5hZGRFdmVudExpc3RlbmVyKFwidGltZXVwZGF0ZVwiLCB1cGRhdGVUaW1lKTtcblxuXG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XG5mdW5jdGlvbiBnZXRCbG9ja0J5QWxpYXMoYWxpYXMpe1xuICByZXR1cm4gJChcIi5yZXZpZXdzX19pdGVtXCIpLmZpbHRlcigoaW5kZXgsIGl0ZW0pID0+IHtcbiAgICByZXR1cm4gJChpdGVtKS5hdHRyKFwiZGF0YS1saW5rZWQtd2l0aFwiKSA9PSBhbGlhc1xuICB9KTtcbn1cblxuJChcIi5pbnRlcmFjdGl2ZS1hdmF0YXJfX2xpbmtcIikub24oXCJjbGlja1wiLCBlID0+IHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gIGNvbnN0ICR0aGlzID0gJChlLmN1cnJlbnRUYXJnZXQpO1xuICBjb25zdCB0YXJnZXQgPSAkdGhpcy5hdHRyKFwiZGF0YS1vcGVuXCIpO1xuICBjb25zdCBpdGVtVG9TaG93ID0gZ2V0QmxvY2tCeUFsaWFzKHRhcmdldCk7XG4gIGNvbnN0IGN1cnJlbnRJdGVtID0gJHRoaXMuY2xvc2VzdChcIi5pbnRlcmFjdGl2ZS1hdmF0YXJcIik7XG5cbiAgaXRlbVRvU2hvdy5hZGRDbGFzcyhcImFjdGl2ZVwiKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKFwiYWN0aXZlXCIpXG4gIGN1cnJlbnRJdGVtLmFkZENsYXNzKFwiYWN0aXZlXCIpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoXCJhY3RpdmVcIilcbn0pXG59KSgpOyIsImxldCBieFNsaWRlck9wdGlvbnM7XG5pZiAod2luZG93LmlubmVyV2lkdGggPj0gNzY4KSB7XG4gIGJ4U2xpZGVyT3B0aW9ucyA9IHtcbiAgcGFnZXI6IGZhbHNlLFxuICBjb250cm9sczogZmFsc2UsXG4gIHRvdWNoRW5hYmxlZDogZmFsc2Vcbn19IGVsc2Uge1xuICBieFNsaWRlck9wdGlvbnMgPSB7XG4gIHBhZ2VyOiBmYWxzZSxcbiAgY29udHJvbHM6IGZhbHNlLFxufX1cbiAgXG5jb25zdCBzbGlkZXIgPSAkKCcuc2xpZGVyX19saXN0JykuYnhTbGlkZXIoYnhTbGlkZXJPcHRpb25zKTtcblxuJChcIi5zbGlkZXJfX2Fycm93LS10eXBlLS1wcmV2XCIpLmNsaWNrKGUgPT4ge1xuICBlLnByZXZlbnREZWZhdWx0KCk7XG4gIHNsaWRlci5nb1RvUHJldlNsaWRlKCk7XG59KTtcblxuJChcIi5zbGlkZXJfX2Fycm93LS10eXBlLS1uZXh0XCIpLmNsaWNrKGUgPT4ge1xuICBlLnByZXZlbnREZWZhdWx0KCk7XG4gIHNsaWRlci5nb1RvTmV4dFNsaWRlKCk7XG59KTsiLCIoZnVuY3Rpb24gKCkge1xuY29uc3QgZW1wbG95ZWVMaXN0RGVzayA9ICQoXCIudGVhbV9fbmFtZVwiLCBcIi50ZWFtX19saXN0LS1kZXNrdG9wXCIpO1xuXG5jb25zdCBlbXBsb3llZUxpc3RNb2JpbGUgPSAkKFwiLnRlYW1fX25hbWVcIiwgXCIudGVhbV9fbGlzdC0tbW9iaWxlXCIpO1xuXG5mdW5jdGlvbiBoaWRlQWNjb3JkZW9uKGVtcGxveWVlTGlzdCl7XG4gIGVtcGxveWVlTGlzdC5lYWNoKChpbmRleCwgZW1wbG95ZWUpID0+IHtcbiAgICBsZXQgZGVzY0VsZW0gPSAkKGVtcGxveWVlKS5uZXh0KCk7XG4gICAgZGVzY0VsZW0uaGVpZ2h0KDApO1xuICAgIGRlc2NFbGVtLnJlbW92ZUNsYXNzKFwiYWN0aXZlXCIpO1xuICAgICQoZW1wbG95ZWUpLnJlbW92ZUNsYXNzKFwidGVhbV9fbmFtZS0tYWN0aXZlXCIpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gc2hvd0FjY29yZGVvbihkZXNjV3JhcEVsZW0sIG5hbWVFbGVtKXtcbiAgbGV0IGRlc2NFbGVtID0gZGVzY1dyYXBFbGVtLmZpbmQoJy50ZWFtX19kZXNjJyk7XG4gIGxldCBoZWlnaHQgPSBkZXNjRWxlbS5jc3MoJ2hlaWdodCcpO1xuICBkZXNjV3JhcEVsZW0uaGVpZ2h0KGhlaWdodCk7XG4gIG5hbWVFbGVtLmFkZENsYXNzKFwidGVhbV9fbmFtZS0tYWN0aXZlXCIpXG4gIGRlc2NXcmFwRWxlbS5hZGRDbGFzcyhcImFjdGl2ZVwiKTtcbn1cblxuZnVuY3Rpb24gaXNEZXNrdG9wKGVsZW0pIHtcbiAgcmV0dXJuIGVsZW0uY2xvc2VzdChcIi50ZWFtX19saXN0LS1kZXNrdG9wXCIpLmxlbmd0aCA9PSAxO1xufTtcblxuJChcIi50ZWFtX19uYW1lXCIpLm9uKFwiY2xpY2tcIiwgZnVuY3Rpb24gKCl7XG4gIGxldCBjdXJyZW50TmFtZSA9ICQodGhpcyk7XG4gIGxldCBkZXNjID0gY3VycmVudE5hbWUubmV4dCgpO1xuXG4gIGlmIChkZXNjLmhhc0NsYXNzKFwiYWN0aXZlXCIpKSB7XG4gICAgaWYgKGlzRGVza3RvcChjdXJyZW50TmFtZSkpe1xuICAgICAgaGlkZUFjY29yZGVvbihlbXBsb3llZUxpc3REZXNrKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaGlkZUFjY29yZGVvbihlbXBsb3llZUxpc3RNb2JpbGUpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAoaXNEZXNrdG9wKGN1cnJlbnROYW1lKSl7XG4gICAgICBoaWRlQWNjb3JkZW9uKGVtcGxveWVlTGlzdERlc2spXG4gICAgfSBlbHNlIHtcbiAgICAgIGhpZGVBY2NvcmRlb24oZW1wbG95ZWVMaXN0TW9iaWxlKVxuICAgIH1cbiAgICBzaG93QWNjb3JkZW9uKGRlc2MsIGN1cnJlbnROYW1lKVxuICB9XG5cbn0pO1xufSkoKTtcbiJdfQ==
