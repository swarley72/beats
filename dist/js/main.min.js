(function () {
const items = document.querySelectorAll(".colors__link");

items.forEach(item => {
  item.addEventListener("click", function(e) {
    e.preventDefault();
    const item = this.closest(".colors__item");
    const container = this.closest(".colors__list");
    const isItemOpened = item.classList.contains("active");
    
    if (isItemOpened) {
      closeAllItems(container);
    } else {
      closeAllItems(container);
      openItem(item);
    }
  })
});

function openItem(item){
  const hiddenDesc = item.querySelector(".colors__desc");
  const textDesc = item.querySelector(".colors__desc-text")
  const width = getWidth(item);
  item.classList.add("active");
  hiddenDesc.style.width = `${width.container}px`;
  textDesc.style.width = `${width.textContainer}px`;
}


function closeAllItems(container) {
  const items = container.querySelectorAll(".colors__item")
  const contentList = container.querySelectorAll(".colors__desc")

  items.forEach(element => {
    element.classList.remove("active")
  });

  contentList.forEach(element => {
    element.style.width = "0px"
  });

}

function getWidth(item) {
  let itemWidth = 0
  const screenWidth = window.innerWidth;
  const container = item.closest(".colors__list");
  const titlesBlocks = container.querySelectorAll(".colors__link");
  const titlesWidth = titlesBlocks[0].offsetWidth * titlesBlocks.length;
  const textContainer = item.querySelector(".colors__desc-text");
  const paddingLeft = parseInt(window.getComputedStyle(textContainer, null).paddingLeft);
  const paddingRight = parseInt(window.getComputedStyle(textContainer, null).paddingRight);

  const isMobile = window.matchMedia("(max-width: 768px)").matches;
  
  if(isMobile) {
    itemWidth = screenWidth - titlesWidth
  } else {
    itemWidth = 500
  }

  return {
    container: itemWidth,
    textContainer: itemWidth - paddingLeft - paddingRight
  }
}
})();;(function () {
  const form = document.querySelector(".form");
  const send = document.querySelector(".form__submit");

  send.addEventListener("click", e => {
    e.preventDefault();
    if (validateForm(form)) {
      console.log("sending to server");
    } else {
      console.log("not sending")
    }
  });

  function validateForm(form) {
    let valid = true;

    if (!validateForm(form.element.name)){
      valid = false;
    }
  }

  function validate(element){
    if (!element.checkValidity()){
      element.nextElementSibling.textContent = element.validationMessage;
      element.style.border = "1px solid red";
      return false;
    } else {
      element.nextElementSibling.textContent = "";
      element.style.border = none;
    }
  }
})();;(function () {
const openBtn = $(".burger");
const closeBtn = $(".fullscreen-menu__close-btn")
const fullScreenMenu = $(".fullscreen-menu");
const menuLink = $(".menu--vertical").find(".menu__item");

openBtn.click(e => {
  fullScreenMenu.css("display", "flex");
  $("body").addClass("body--scroll--lock");
});

closeBtn.click(e => {
  fullScreenMenu.css("display", "none");
  $("body").removeClass("body--scroll--lock");
});

menuLink.click(e => {
  e.preventDefault();
  fullScreenMenu.css("display", "none");
  $("body").removeClass("body--scroll--lock");
  
});
})();;(function () {
let myMap;

function init() {
  myMap = new ymaps.Map("map", {
    center: [55.76, 37.64],
    zoom: 11,
    controls: [

    ]
  });

  const coords = [
    [55.737805, 37.591579],
    [55.720057, 37.630307],
    [55.759343, 37.640231]
  ];

  const myCollection = new ymaps.GeoObjectCollection({}, {
    draggable: true,
    iconLayout: 'default#image',
    iconImageHref: "./img/icons/marker.svg",
    iconImageSize: [50, 73],
    iconImageOffset: []
  });

  coords.forEach(coord => {
    myCollection.add(new ymaps.Placemark(coord));
  })

  myMap.geoObjects.add(myCollection);
  myMap.behaviors.disable("scrollZoom")
}

ymaps.ready(init)

})();;(function () {
function validateForm(form, fieldsArray){
  fieldsArray.forEach(field => {
    field.removeClass("input-error");
    if (field.val().trim() == "") {
      field.addClass("input-error");
    }
  })

  const errorFields = form.find(".input-error");

  return errorFields.length == 0
}


$('.form').submit(e => {
  e.preventDefault();

  const form = $(e.currentTarget);
  const name = form.find("[name='name']");
  const phone = form.find("[name='phone']");
  const comment = form.find("[name='comment']");
  const to = form.find("[name='to']");

  const modal = $(".modal");
  const modalText = modal.find(".modal__text");
  modalText.removeClass('modal__text--error')

  const isValid = validateForm(form, [name, phone, comment, to])

  if (isValid) {
    const request = $.ajax({
      url: "https://webdev-api.loftschool.com/sendmail",
      method: 'post',
      data: {
        name: name.val(),
        phone: phone.val(),
        comment: comment.val(),
        to: to.val(),
      },
    });

    request.done(data => {
      modalText.text(data.message)
    });
    
    request.fail(data => {
      const message = data.responseJSON.message
      modalText.text(message)
      modalText.addClass('modal__text--error')  
    })

    request.always(() => {
      $.fancybox.open({
        src: '#modal',
        type: 'inline'
      })
    })
  }
});


$('.js-modal-button').click(e => {
  e.preventDefault();

  $.fancybox.close();
})
})();;(function () {
const sections = $("section");
const display = $(".maincontent");
const sidemenu = $(".fixed-menu");
const sidemenuItems = sidemenu.find(".fixed-menu__item")
const mobileDetect = new MobileDetect(window.navigator.userAgent);
const isMobile = mobileDetect.mobile();


let inScroll = false;

sections.first().addClass("active");

function countSectionPosition(sectionEq) {
  const position = sectionEq * -100;

  if (isNaN(position)) {
    console.erro("not a number")
    return 0
  }
  return position
}

function changeSidemenuColor(sectionEq) {
  const currentSection = sections.eq(sectionEq);
  const sidemenuColor = currentSection.attr("data-sidemenu-color");

  if (sidemenuColor == "white") {
    sidemenu.addClass("fixed-menu--color--white")
  } else {
    sidemenu.removeClass("fixed-menu--color--white")
  }
}

function resetActiveClassForItem(items, itemEq, activeClass) {
  items.eq(itemEq).addClass(activeClass).siblings().removeClass(activeClass);
}

function performTransition(sectionEq) {
  if (inScroll) return
  const transitionOver = 600;
  const mouseInertionOver = 300;
  inScroll = true;

  const position = countSectionPosition(sectionEq);

  changeSidemenuColor(sectionEq);

  display.css({
    transform: `translateY(${position}%)`
  })

  resetActiveClassForItem(sections, sectionEq, "active")
  
  setTimeout(() => {
    inScroll = false;

    resetActiveClassForItem(sidemenuItems, sectionEq, "fixed-menu__item--active");

  }, transitionOver + mouseInertionOver);
}

function viewportScroller() {
  const activeSection = sections.filter(".active");
  const nextSection = activeSection.next();
  const prevSection = activeSection.prev();

  return {
    next() {
      if (nextSection.length) {
        performTransition(nextSection.index())
      }
    },

    prev() {
      if (prevSection.length) {
      performTransition(prevSection.index())
      }
    }
  }
}

$(window).on("wheel", e => {
  const deltaY = e.originalEvent.deltaY;
  const scroller = viewportScroller();

  if (deltaY > 0) {
    scroller.next()
  }
  
  if (deltaY < 0) {
    scroller.prev()
  }
})

$(window).on("keydown", e => {
  const tagName = e.target.tagName.toLowerCase();
  const userTypingInInputs = tagName == "input" && tagName == "textarea";
  const scroller = viewportScroller();

  if (userTypingInInputs) return

  switch(e.keyCode) {
    case 38: //prev
      scroller.prev();
      break;

    case 40: //next
      scroller.next();
      break;
    }
})

$("[data-scroll-to]").click(e => {
  e.preventDefault();

  const $this = $(e.currentTarget);
  const target = $this.attr("data-scroll-to");
  const reqSection = $(`[data-section-id=${target}]`);

  performTransition(reqSection.index());
})


if (isMobile) {
  $("body").swipe( {
    //Generic swipe handler for all directions
    swipe: function(event, direction) {
      const scroller = viewportScroller();
      let scrollDirection = "";
  
      if (direction == "up") scrollDirection = "next";
      if (direction == "down") scrollDirection = "prev";
  
      scroller[scrollDirection]();
    }
  });
  
  $(".wrapper").on("touchmove", e => e.preventDefault());

}
})();;let player;
const playerContainer = document.querySelector(".player")

function eventsInit() {
  document.querySelector(".player__start").addEventListener("click", e => {
    e.preventDefault();
    
    if (playerContainer.classList.contains("paused")) {
      player.pauseVideo()
    } else {
      player.playVideo()
    }
  });

  document.querySelector(".player__playback").addEventListener("click", e => {
    const bar = e.currentTarget;
    const clickedPosition = e.layerX;

    const newButtonPositionPercent = (clickedPosition / bar.offsetWidth) * 100;
    const newPlaybackPositionSec = (player.getDuration() / 100) * newButtonPositionPercent;
    document.querySelector(".player__playback-button").style.left = `${newButtonPositionPercent}%`

    player.seekTo(newPlaybackPositionSec)
  })

}

function onPlayerReady() {
  let interval;
  const durationSec = player.getDuration();
  document.querySelector(".player__duration-estimate").innerHTML = formatTime(durationSec)

  if (typeof interval != 'undefined') {
    clearInterval(interval);
  }

  interval = setInterval(() => {
    const completedSec = player.getCurrentTime();
    const completedPercents = (completedSec / durationSec) * 100;
    document.querySelector(".player__playback-button").style.left = `${completedPercents}%`

    document.querySelector(".player__duration-completed").innerHTML = formatTime(completedSec)
  }, 1000);
}

function formatTime(timeSec) {
  const roundTime = Math.round(timeSec);
  const minutes = addZero(Math.floor(roundTime / 60));
  const seconds = addZero(roundTime - minutes * 60);

  function addZero(num) {
    return num < 10 ? `0${num}`: num;
  }

  return `${minutes}:${seconds}`
}

function onPlayerStateChange(event) {
  /*
  -1 (воспроизведение видео не начато)
  0 (воспроизведение видео завершено)
  1 (воспроизведение)
  2 (пауза)
  3 (буферизация)
  5 (видео подают реплики).
 */
  switch (event.data){
    case 1:
      playerContainer.classList.add("active")
      playerContainer.classList.add("paused")
      
      break;
      
      case 2:
        playerContainer.classList.remove("active")
        playerContainer.classList.remove("paused")
      break;
  }
}


function onYouTubeIframeAPIReady() {
  player = new YT.Player('yt-player', {
    height: '390',
    width: '660',
    videoId: 'l6yOamCT5BQ',
    events: {
      'onReady': onPlayerReady,
      'onStateChange': onPlayerStateChange
    },
    playerVars: {
      controls: 0,
      disablekb: 0,
      showinfo: 0,
      rel: 0,
      autoplay: 0,
      modestbranding: 0
    }
  });
}
eventsInit();
;(function () {
function getBlockByAlias(alias){
  return $(".reviews__item").filter((index, item) => {
    return $(item).attr("data-linked-with") == alias
  });
}

$(".interactive-avatar__link").on("click", e => {
  e.preventDefault();

  const $this = $(e.currentTarget);
  const target = $this.attr("data-open");
  const itemToShow = getBlockByAlias(target);
  const currentItem = $this.closest(".interactive-avatar");

  itemToShow.addClass("active").siblings().removeClass("active")
  currentItem.addClass("active").siblings().removeClass("active")
})
})();;const slider = $('.slider__list').bxSlider({
  pager: false,
  controls: false
});

$(".slider__arrow--type--prev").click(e => {
  e.preventDefault();
  slider.goToPrevSlide();
});

$(".slider__arrow--type--next").click(e => {
  e.preventDefault();
  slider.goToNextSlide();
});;(function () {
const employeeListDesk = $(".team__name", ".team__list--desktop");

const employeeListMobile = $(".team__name", ".team__list--mobile");

function hideAccordeon(employeeList){
  employeeList.each((index, employee) => {
    let descElem = $(employee).next();
    descElem.height(0);
    descElem.removeClass("active");
    $(employee).removeClass("team__name--active");
  });
}

function showAccordeon(descWrapElem, nameElem){
  let descElem = descWrapElem.find('.team__desc');
  let height = descElem.css('height');
  descWrapElem.height(height);
  nameElem.addClass("team__name--active")
  descWrapElem.addClass("active");
}

function isDesktop(elem) {
  return elem.closest(".team__list--desktop").length == 1;
};

$(".team__name").on("click", function (){
  let currentName = $(this);
  let desc = currentName.next();

  if (desc.hasClass("active")) {
    if (isDesktop(currentName)){
      hideAccordeon(employeeListDesk);
    } else {
      hideAccordeon(employeeListMobile);
    }
  } else {
    if (isDesktop(currentName)){
      hideAccordeon(employeeListDesk)
    } else {
      hideAccordeon(employeeListMobile)
    }
    showAccordeon(desc, currentName)
  }

});
})();

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbG9ycy5qcyIsImZvcm0uanMiLCJmdWxsc2NyZWVuLW1lbnUuanMiLCJtYXAuanMiLCJtb2RhbC5qcyIsIm9wcy5qcyIsInBsYXllci5qcyIsInJldmlld3MuanMiLCJzbGlkZXIuanMiLCJ0ZWFtLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1DbEVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUMvQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQ3RCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQ3BDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1DbkVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1DN0lBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQ3JHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQ2xCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElDYkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6Im1haW4ubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uICgpIHtcbmNvbnN0IGl0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5jb2xvcnNfX2xpbmtcIik7XG5cbml0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGZ1bmN0aW9uKGUpIHtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgY29uc3QgaXRlbSA9IHRoaXMuY2xvc2VzdChcIi5jb2xvcnNfX2l0ZW1cIik7XG4gICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jbG9zZXN0KFwiLmNvbG9yc19fbGlzdFwiKTtcbiAgICBjb25zdCBpc0l0ZW1PcGVuZWQgPSBpdGVtLmNsYXNzTGlzdC5jb250YWlucyhcImFjdGl2ZVwiKTtcbiAgICBcbiAgICBpZiAoaXNJdGVtT3BlbmVkKSB7XG4gICAgICBjbG9zZUFsbEl0ZW1zKGNvbnRhaW5lcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNsb3NlQWxsSXRlbXMoY29udGFpbmVyKTtcbiAgICAgIG9wZW5JdGVtKGl0ZW0pO1xuICAgIH1cbiAgfSlcbn0pO1xuXG5mdW5jdGlvbiBvcGVuSXRlbShpdGVtKXtcbiAgY29uc3QgaGlkZGVuRGVzYyA9IGl0ZW0ucXVlcnlTZWxlY3RvcihcIi5jb2xvcnNfX2Rlc2NcIik7XG4gIGNvbnN0IHRleHREZXNjID0gaXRlbS5xdWVyeVNlbGVjdG9yKFwiLmNvbG9yc19fZGVzYy10ZXh0XCIpXG4gIGNvbnN0IHdpZHRoID0gZ2V0V2lkdGgoaXRlbSk7XG4gIGl0ZW0uY2xhc3NMaXN0LmFkZChcImFjdGl2ZVwiKTtcbiAgaGlkZGVuRGVzYy5zdHlsZS53aWR0aCA9IGAke3dpZHRoLmNvbnRhaW5lcn1weGA7XG4gIHRleHREZXNjLnN0eWxlLndpZHRoID0gYCR7d2lkdGgudGV4dENvbnRhaW5lcn1weGA7XG59XG5cblxuZnVuY3Rpb24gY2xvc2VBbGxJdGVtcyhjb250YWluZXIpIHtcbiAgY29uc3QgaXRlbXMgPSBjb250YWluZXIucXVlcnlTZWxlY3RvckFsbChcIi5jb2xvcnNfX2l0ZW1cIilcbiAgY29uc3QgY29udGVudExpc3QgPSBjb250YWluZXIucXVlcnlTZWxlY3RvckFsbChcIi5jb2xvcnNfX2Rlc2NcIilcblxuICBpdGVtcy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgIGVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZShcImFjdGl2ZVwiKVxuICB9KTtcblxuICBjb250ZW50TGlzdC5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgIGVsZW1lbnQuc3R5bGUud2lkdGggPSBcIjBweFwiXG4gIH0pO1xuXG59XG5cbmZ1bmN0aW9uIGdldFdpZHRoKGl0ZW0pIHtcbiAgbGV0IGl0ZW1XaWR0aCA9IDBcbiAgY29uc3Qgc2NyZWVuV2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgY29uc3QgY29udGFpbmVyID0gaXRlbS5jbG9zZXN0KFwiLmNvbG9yc19fbGlzdFwiKTtcbiAgY29uc3QgdGl0bGVzQmxvY2tzID0gY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3JBbGwoXCIuY29sb3JzX19saW5rXCIpO1xuICBjb25zdCB0aXRsZXNXaWR0aCA9IHRpdGxlc0Jsb2Nrc1swXS5vZmZzZXRXaWR0aCAqIHRpdGxlc0Jsb2Nrcy5sZW5ndGg7XG4gIGNvbnN0IHRleHRDb250YWluZXIgPSBpdGVtLnF1ZXJ5U2VsZWN0b3IoXCIuY29sb3JzX19kZXNjLXRleHRcIik7XG4gIGNvbnN0IHBhZGRpbmdMZWZ0ID0gcGFyc2VJbnQod2luZG93LmdldENvbXB1dGVkU3R5bGUodGV4dENvbnRhaW5lciwgbnVsbCkucGFkZGluZ0xlZnQpO1xuICBjb25zdCBwYWRkaW5nUmlnaHQgPSBwYXJzZUludCh3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh0ZXh0Q29udGFpbmVyLCBudWxsKS5wYWRkaW5nUmlnaHQpO1xuXG4gIGNvbnN0IGlzTW9iaWxlID0gd2luZG93Lm1hdGNoTWVkaWEoXCIobWF4LXdpZHRoOiA3NjhweClcIikubWF0Y2hlcztcbiAgXG4gIGlmKGlzTW9iaWxlKSB7XG4gICAgaXRlbVdpZHRoID0gc2NyZWVuV2lkdGggLSB0aXRsZXNXaWR0aFxuICB9IGVsc2Uge1xuICAgIGl0ZW1XaWR0aCA9IDUwMFxuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBjb250YWluZXI6IGl0ZW1XaWR0aCxcbiAgICB0ZXh0Q29udGFpbmVyOiBpdGVtV2lkdGggLSBwYWRkaW5nTGVmdCAtIHBhZGRpbmdSaWdodFxuICB9XG59XG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IGZvcm0gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLmZvcm1cIik7XG4gIGNvbnN0IHNlbmQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLmZvcm1fX3N1Ym1pdFwiKTtcblxuICBzZW5kLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBlID0+IHtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgaWYgKHZhbGlkYXRlRm9ybShmb3JtKSkge1xuICAgICAgY29uc29sZS5sb2coXCJzZW5kaW5nIHRvIHNlcnZlclwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coXCJub3Qgc2VuZGluZ1wiKVxuICAgIH1cbiAgfSk7XG5cbiAgZnVuY3Rpb24gdmFsaWRhdGVGb3JtKGZvcm0pIHtcbiAgICBsZXQgdmFsaWQgPSB0cnVlO1xuXG4gICAgaWYgKCF2YWxpZGF0ZUZvcm0oZm9ybS5lbGVtZW50Lm5hbWUpKXtcbiAgICAgIHZhbGlkID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gdmFsaWRhdGUoZWxlbWVudCl7XG4gICAgaWYgKCFlbGVtZW50LmNoZWNrVmFsaWRpdHkoKSl7XG4gICAgICBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZy50ZXh0Q29udGVudCA9IGVsZW1lbnQudmFsaWRhdGlvbk1lc3NhZ2U7XG4gICAgICBlbGVtZW50LnN0eWxlLmJvcmRlciA9IFwiMXB4IHNvbGlkIHJlZFwiO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZy50ZXh0Q29udGVudCA9IFwiXCI7XG4gICAgICBlbGVtZW50LnN0eWxlLmJvcmRlciA9IG5vbmU7XG4gICAgfVxuICB9XG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XG5jb25zdCBvcGVuQnRuID0gJChcIi5idXJnZXJcIik7XG5jb25zdCBjbG9zZUJ0biA9ICQoXCIuZnVsbHNjcmVlbi1tZW51X19jbG9zZS1idG5cIilcbmNvbnN0IGZ1bGxTY3JlZW5NZW51ID0gJChcIi5mdWxsc2NyZWVuLW1lbnVcIik7XG5jb25zdCBtZW51TGluayA9ICQoXCIubWVudS0tdmVydGljYWxcIikuZmluZChcIi5tZW51X19pdGVtXCIpO1xuXG5vcGVuQnRuLmNsaWNrKGUgPT4ge1xuICBmdWxsU2NyZWVuTWVudS5jc3MoXCJkaXNwbGF5XCIsIFwiZmxleFwiKTtcbiAgJChcImJvZHlcIikuYWRkQ2xhc3MoXCJib2R5LS1zY3JvbGwtLWxvY2tcIik7XG59KTtcblxuY2xvc2VCdG4uY2xpY2soZSA9PiB7XG4gIGZ1bGxTY3JlZW5NZW51LmNzcyhcImRpc3BsYXlcIiwgXCJub25lXCIpO1xuICAkKFwiYm9keVwiKS5yZW1vdmVDbGFzcyhcImJvZHktLXNjcm9sbC0tbG9ja1wiKTtcbn0pO1xuXG5tZW51TGluay5jbGljayhlID0+IHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICBmdWxsU2NyZWVuTWVudS5jc3MoXCJkaXNwbGF5XCIsIFwibm9uZVwiKTtcbiAgJChcImJvZHlcIikucmVtb3ZlQ2xhc3MoXCJib2R5LS1zY3JvbGwtLWxvY2tcIik7XG4gIFxufSk7XG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XG5sZXQgbXlNYXA7XG5cbmZ1bmN0aW9uIGluaXQoKSB7XG4gIG15TWFwID0gbmV3IHltYXBzLk1hcChcIm1hcFwiLCB7XG4gICAgY2VudGVyOiBbNTUuNzYsIDM3LjY0XSxcbiAgICB6b29tOiAxMSxcbiAgICBjb250cm9sczogW1xuXG4gICAgXVxuICB9KTtcblxuICBjb25zdCBjb29yZHMgPSBbXG4gICAgWzU1LjczNzgwNSwgMzcuNTkxNTc5XSxcbiAgICBbNTUuNzIwMDU3LCAzNy42MzAzMDddLFxuICAgIFs1NS43NTkzNDMsIDM3LjY0MDIzMV1cbiAgXTtcblxuICBjb25zdCBteUNvbGxlY3Rpb24gPSBuZXcgeW1hcHMuR2VvT2JqZWN0Q29sbGVjdGlvbih7fSwge1xuICAgIGRyYWdnYWJsZTogdHJ1ZSxcbiAgICBpY29uTGF5b3V0OiAnZGVmYXVsdCNpbWFnZScsXG4gICAgaWNvbkltYWdlSHJlZjogXCIuL2ltZy9pY29ucy9tYXJrZXIuc3ZnXCIsXG4gICAgaWNvbkltYWdlU2l6ZTogWzUwLCA3M10sXG4gICAgaWNvbkltYWdlT2Zmc2V0OiBbXVxuICB9KTtcblxuICBjb29yZHMuZm9yRWFjaChjb29yZCA9PiB7XG4gICAgbXlDb2xsZWN0aW9uLmFkZChuZXcgeW1hcHMuUGxhY2VtYXJrKGNvb3JkKSk7XG4gIH0pXG5cbiAgbXlNYXAuZ2VvT2JqZWN0cy5hZGQobXlDb2xsZWN0aW9uKTtcbiAgbXlNYXAuYmVoYXZpb3JzLmRpc2FibGUoXCJzY3JvbGxab29tXCIpXG59XG5cbnltYXBzLnJlYWR5KGluaXQpXG5cbn0pKCk7IiwiKGZ1bmN0aW9uICgpIHtcbmZ1bmN0aW9uIHZhbGlkYXRlRm9ybShmb3JtLCBmaWVsZHNBcnJheSl7XG4gIGZpZWxkc0FycmF5LmZvckVhY2goZmllbGQgPT4ge1xuICAgIGZpZWxkLnJlbW92ZUNsYXNzKFwiaW5wdXQtZXJyb3JcIik7XG4gICAgaWYgKGZpZWxkLnZhbCgpLnRyaW0oKSA9PSBcIlwiKSB7XG4gICAgICBmaWVsZC5hZGRDbGFzcyhcImlucHV0LWVycm9yXCIpO1xuICAgIH1cbiAgfSlcblxuICBjb25zdCBlcnJvckZpZWxkcyA9IGZvcm0uZmluZChcIi5pbnB1dC1lcnJvclwiKTtcblxuICByZXR1cm4gZXJyb3JGaWVsZHMubGVuZ3RoID09IDBcbn1cblxuXG4kKCcuZm9ybScpLnN1Ym1pdChlID0+IHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gIGNvbnN0IGZvcm0gPSAkKGUuY3VycmVudFRhcmdldCk7XG4gIGNvbnN0IG5hbWUgPSBmb3JtLmZpbmQoXCJbbmFtZT0nbmFtZSddXCIpO1xuICBjb25zdCBwaG9uZSA9IGZvcm0uZmluZChcIltuYW1lPSdwaG9uZSddXCIpO1xuICBjb25zdCBjb21tZW50ID0gZm9ybS5maW5kKFwiW25hbWU9J2NvbW1lbnQnXVwiKTtcbiAgY29uc3QgdG8gPSBmb3JtLmZpbmQoXCJbbmFtZT0ndG8nXVwiKTtcblxuICBjb25zdCBtb2RhbCA9ICQoXCIubW9kYWxcIik7XG4gIGNvbnN0IG1vZGFsVGV4dCA9IG1vZGFsLmZpbmQoXCIubW9kYWxfX3RleHRcIik7XG4gIG1vZGFsVGV4dC5yZW1vdmVDbGFzcygnbW9kYWxfX3RleHQtLWVycm9yJylcblxuICBjb25zdCBpc1ZhbGlkID0gdmFsaWRhdGVGb3JtKGZvcm0sIFtuYW1lLCBwaG9uZSwgY29tbWVudCwgdG9dKVxuXG4gIGlmIChpc1ZhbGlkKSB7XG4gICAgY29uc3QgcmVxdWVzdCA9ICQuYWpheCh7XG4gICAgICB1cmw6IFwiaHR0cHM6Ly93ZWJkZXYtYXBpLmxvZnRzY2hvb2wuY29tL3NlbmRtYWlsXCIsXG4gICAgICBtZXRob2Q6ICdwb3N0JyxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgbmFtZTogbmFtZS52YWwoKSxcbiAgICAgICAgcGhvbmU6IHBob25lLnZhbCgpLFxuICAgICAgICBjb21tZW50OiBjb21tZW50LnZhbCgpLFxuICAgICAgICB0bzogdG8udmFsKCksXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmVxdWVzdC5kb25lKGRhdGEgPT4ge1xuICAgICAgbW9kYWxUZXh0LnRleHQoZGF0YS5tZXNzYWdlKVxuICAgIH0pO1xuICAgIFxuICAgIHJlcXVlc3QuZmFpbChkYXRhID0+IHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBkYXRhLnJlc3BvbnNlSlNPTi5tZXNzYWdlXG4gICAgICBtb2RhbFRleHQudGV4dChtZXNzYWdlKVxuICAgICAgbW9kYWxUZXh0LmFkZENsYXNzKCdtb2RhbF9fdGV4dC0tZXJyb3InKSAgXG4gICAgfSlcblxuICAgIHJlcXVlc3QuYWx3YXlzKCgpID0+IHtcbiAgICAgICQuZmFuY3lib3gub3Blbih7XG4gICAgICAgIHNyYzogJyNtb2RhbCcsXG4gICAgICAgIHR5cGU6ICdpbmxpbmUnXG4gICAgICB9KVxuICAgIH0pXG4gIH1cbn0pO1xuXG5cbiQoJy5qcy1tb2RhbC1idXR0b24nKS5jbGljayhlID0+IHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICQuZmFuY3lib3guY2xvc2UoKTtcbn0pXG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XG5jb25zdCBzZWN0aW9ucyA9ICQoXCJzZWN0aW9uXCIpO1xuY29uc3QgZGlzcGxheSA9ICQoXCIubWFpbmNvbnRlbnRcIik7XG5jb25zdCBzaWRlbWVudSA9ICQoXCIuZml4ZWQtbWVudVwiKTtcbmNvbnN0IHNpZGVtZW51SXRlbXMgPSBzaWRlbWVudS5maW5kKFwiLmZpeGVkLW1lbnVfX2l0ZW1cIilcbmNvbnN0IG1vYmlsZURldGVjdCA9IG5ldyBNb2JpbGVEZXRlY3Qod2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpO1xuY29uc3QgaXNNb2JpbGUgPSBtb2JpbGVEZXRlY3QubW9iaWxlKCk7XG5cblxubGV0IGluU2Nyb2xsID0gZmFsc2U7XG5cbnNlY3Rpb25zLmZpcnN0KCkuYWRkQ2xhc3MoXCJhY3RpdmVcIik7XG5cbmZ1bmN0aW9uIGNvdW50U2VjdGlvblBvc2l0aW9uKHNlY3Rpb25FcSkge1xuICBjb25zdCBwb3NpdGlvbiA9IHNlY3Rpb25FcSAqIC0xMDA7XG5cbiAgaWYgKGlzTmFOKHBvc2l0aW9uKSkge1xuICAgIGNvbnNvbGUuZXJybyhcIm5vdCBhIG51bWJlclwiKVxuICAgIHJldHVybiAwXG4gIH1cbiAgcmV0dXJuIHBvc2l0aW9uXG59XG5cbmZ1bmN0aW9uIGNoYW5nZVNpZGVtZW51Q29sb3Ioc2VjdGlvbkVxKSB7XG4gIGNvbnN0IGN1cnJlbnRTZWN0aW9uID0gc2VjdGlvbnMuZXEoc2VjdGlvbkVxKTtcbiAgY29uc3Qgc2lkZW1lbnVDb2xvciA9IGN1cnJlbnRTZWN0aW9uLmF0dHIoXCJkYXRhLXNpZGVtZW51LWNvbG9yXCIpO1xuXG4gIGlmIChzaWRlbWVudUNvbG9yID09IFwid2hpdGVcIikge1xuICAgIHNpZGVtZW51LmFkZENsYXNzKFwiZml4ZWQtbWVudS0tY29sb3ItLXdoaXRlXCIpXG4gIH0gZWxzZSB7XG4gICAgc2lkZW1lbnUucmVtb3ZlQ2xhc3MoXCJmaXhlZC1tZW51LS1jb2xvci0td2hpdGVcIilcbiAgfVxufVxuXG5mdW5jdGlvbiByZXNldEFjdGl2ZUNsYXNzRm9ySXRlbShpdGVtcywgaXRlbUVxLCBhY3RpdmVDbGFzcykge1xuICBpdGVtcy5lcShpdGVtRXEpLmFkZENsYXNzKGFjdGl2ZUNsYXNzKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKGFjdGl2ZUNsYXNzKTtcbn1cblxuZnVuY3Rpb24gcGVyZm9ybVRyYW5zaXRpb24oc2VjdGlvbkVxKSB7XG4gIGlmIChpblNjcm9sbCkgcmV0dXJuXG4gIGNvbnN0IHRyYW5zaXRpb25PdmVyID0gNjAwO1xuICBjb25zdCBtb3VzZUluZXJ0aW9uT3ZlciA9IDMwMDtcbiAgaW5TY3JvbGwgPSB0cnVlO1xuXG4gIGNvbnN0IHBvc2l0aW9uID0gY291bnRTZWN0aW9uUG9zaXRpb24oc2VjdGlvbkVxKTtcblxuICBjaGFuZ2VTaWRlbWVudUNvbG9yKHNlY3Rpb25FcSk7XG5cbiAgZGlzcGxheS5jc3Moe1xuICAgIHRyYW5zZm9ybTogYHRyYW5zbGF0ZVkoJHtwb3NpdGlvbn0lKWBcbiAgfSlcblxuICByZXNldEFjdGl2ZUNsYXNzRm9ySXRlbShzZWN0aW9ucywgc2VjdGlvbkVxLCBcImFjdGl2ZVwiKVxuICBcbiAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgaW5TY3JvbGwgPSBmYWxzZTtcblxuICAgIHJlc2V0QWN0aXZlQ2xhc3NGb3JJdGVtKHNpZGVtZW51SXRlbXMsIHNlY3Rpb25FcSwgXCJmaXhlZC1tZW51X19pdGVtLS1hY3RpdmVcIik7XG5cbiAgfSwgdHJhbnNpdGlvbk92ZXIgKyBtb3VzZUluZXJ0aW9uT3Zlcik7XG59XG5cbmZ1bmN0aW9uIHZpZXdwb3J0U2Nyb2xsZXIoKSB7XG4gIGNvbnN0IGFjdGl2ZVNlY3Rpb24gPSBzZWN0aW9ucy5maWx0ZXIoXCIuYWN0aXZlXCIpO1xuICBjb25zdCBuZXh0U2VjdGlvbiA9IGFjdGl2ZVNlY3Rpb24ubmV4dCgpO1xuICBjb25zdCBwcmV2U2VjdGlvbiA9IGFjdGl2ZVNlY3Rpb24ucHJldigpO1xuXG4gIHJldHVybiB7XG4gICAgbmV4dCgpIHtcbiAgICAgIGlmIChuZXh0U2VjdGlvbi5sZW5ndGgpIHtcbiAgICAgICAgcGVyZm9ybVRyYW5zaXRpb24obmV4dFNlY3Rpb24uaW5kZXgoKSlcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgcHJldigpIHtcbiAgICAgIGlmIChwcmV2U2VjdGlvbi5sZW5ndGgpIHtcbiAgICAgIHBlcmZvcm1UcmFuc2l0aW9uKHByZXZTZWN0aW9uLmluZGV4KCkpXG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbiQod2luZG93KS5vbihcIndoZWVsXCIsIGUgPT4ge1xuICBjb25zdCBkZWx0YVkgPSBlLm9yaWdpbmFsRXZlbnQuZGVsdGFZO1xuICBjb25zdCBzY3JvbGxlciA9IHZpZXdwb3J0U2Nyb2xsZXIoKTtcblxuICBpZiAoZGVsdGFZID4gMCkge1xuICAgIHNjcm9sbGVyLm5leHQoKVxuICB9XG4gIFxuICBpZiAoZGVsdGFZIDwgMCkge1xuICAgIHNjcm9sbGVyLnByZXYoKVxuICB9XG59KVxuXG4kKHdpbmRvdykub24oXCJrZXlkb3duXCIsIGUgPT4ge1xuICBjb25zdCB0YWdOYW1lID0gZS50YXJnZXQudGFnTmFtZS50b0xvd2VyQ2FzZSgpO1xuICBjb25zdCB1c2VyVHlwaW5nSW5JbnB1dHMgPSB0YWdOYW1lID09IFwiaW5wdXRcIiAmJiB0YWdOYW1lID09IFwidGV4dGFyZWFcIjtcbiAgY29uc3Qgc2Nyb2xsZXIgPSB2aWV3cG9ydFNjcm9sbGVyKCk7XG5cbiAgaWYgKHVzZXJUeXBpbmdJbklucHV0cykgcmV0dXJuXG5cbiAgc3dpdGNoKGUua2V5Q29kZSkge1xuICAgIGNhc2UgMzg6IC8vcHJldlxuICAgICAgc2Nyb2xsZXIucHJldigpO1xuICAgICAgYnJlYWs7XG5cbiAgICBjYXNlIDQwOiAvL25leHRcbiAgICAgIHNjcm9sbGVyLm5leHQoKTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbn0pXG5cbiQoXCJbZGF0YS1zY3JvbGwtdG9dXCIpLmNsaWNrKGUgPT4ge1xuICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgY29uc3QgJHRoaXMgPSAkKGUuY3VycmVudFRhcmdldCk7XG4gIGNvbnN0IHRhcmdldCA9ICR0aGlzLmF0dHIoXCJkYXRhLXNjcm9sbC10b1wiKTtcbiAgY29uc3QgcmVxU2VjdGlvbiA9ICQoYFtkYXRhLXNlY3Rpb24taWQ9JHt0YXJnZXR9XWApO1xuXG4gIHBlcmZvcm1UcmFuc2l0aW9uKHJlcVNlY3Rpb24uaW5kZXgoKSk7XG59KVxuXG5cbmlmIChpc01vYmlsZSkge1xuICAkKFwiYm9keVwiKS5zd2lwZSgge1xuICAgIC8vR2VuZXJpYyBzd2lwZSBoYW5kbGVyIGZvciBhbGwgZGlyZWN0aW9uc1xuICAgIHN3aXBlOiBmdW5jdGlvbihldmVudCwgZGlyZWN0aW9uKSB7XG4gICAgICBjb25zdCBzY3JvbGxlciA9IHZpZXdwb3J0U2Nyb2xsZXIoKTtcbiAgICAgIGxldCBzY3JvbGxEaXJlY3Rpb24gPSBcIlwiO1xuICBcbiAgICAgIGlmIChkaXJlY3Rpb24gPT0gXCJ1cFwiKSBzY3JvbGxEaXJlY3Rpb24gPSBcIm5leHRcIjtcbiAgICAgIGlmIChkaXJlY3Rpb24gPT0gXCJkb3duXCIpIHNjcm9sbERpcmVjdGlvbiA9IFwicHJldlwiO1xuICBcbiAgICAgIHNjcm9sbGVyW3Njcm9sbERpcmVjdGlvbl0oKTtcbiAgICB9XG4gIH0pO1xuICBcbiAgJChcIi53cmFwcGVyXCIpLm9uKFwidG91Y2htb3ZlXCIsIGUgPT4gZS5wcmV2ZW50RGVmYXVsdCgpKTtcblxufVxufSkoKTsiLCJsZXQgcGxheWVyO1xuY29uc3QgcGxheWVyQ29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5wbGF5ZXJcIilcblxuZnVuY3Rpb24gZXZlbnRzSW5pdCgpIHtcbiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5wbGF5ZXJfX3N0YXJ0XCIpLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBlID0+IHtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgXG4gICAgaWYgKHBsYXllckNvbnRhaW5lci5jbGFzc0xpc3QuY29udGFpbnMoXCJwYXVzZWRcIikpIHtcbiAgICAgIHBsYXllci5wYXVzZVZpZGVvKClcbiAgICB9IGVsc2Uge1xuICAgICAgcGxheWVyLnBsYXlWaWRlbygpXG4gICAgfVxuICB9KTtcblxuICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLnBsYXllcl9fcGxheWJhY2tcIikuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGUgPT4ge1xuICAgIGNvbnN0IGJhciA9IGUuY3VycmVudFRhcmdldDtcbiAgICBjb25zdCBjbGlja2VkUG9zaXRpb24gPSBlLmxheWVyWDtcblxuICAgIGNvbnN0IG5ld0J1dHRvblBvc2l0aW9uUGVyY2VudCA9IChjbGlja2VkUG9zaXRpb24gLyBiYXIub2Zmc2V0V2lkdGgpICogMTAwO1xuICAgIGNvbnN0IG5ld1BsYXliYWNrUG9zaXRpb25TZWMgPSAocGxheWVyLmdldER1cmF0aW9uKCkgLyAxMDApICogbmV3QnV0dG9uUG9zaXRpb25QZXJjZW50O1xuICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucGxheWVyX19wbGF5YmFjay1idXR0b25cIikuc3R5bGUubGVmdCA9IGAke25ld0J1dHRvblBvc2l0aW9uUGVyY2VudH0lYFxuXG4gICAgcGxheWVyLnNlZWtUbyhuZXdQbGF5YmFja1Bvc2l0aW9uU2VjKVxuICB9KVxuXG59XG5cbmZ1bmN0aW9uIG9uUGxheWVyUmVhZHkoKSB7XG4gIGxldCBpbnRlcnZhbDtcbiAgY29uc3QgZHVyYXRpb25TZWMgPSBwbGF5ZXIuZ2V0RHVyYXRpb24oKTtcbiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5wbGF5ZXJfX2R1cmF0aW9uLWVzdGltYXRlXCIpLmlubmVySFRNTCA9IGZvcm1hdFRpbWUoZHVyYXRpb25TZWMpXG5cbiAgaWYgKHR5cGVvZiBpbnRlcnZhbCAhPSAndW5kZWZpbmVkJykge1xuICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWwpO1xuICB9XG5cbiAgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgY29uc3QgY29tcGxldGVkU2VjID0gcGxheWVyLmdldEN1cnJlbnRUaW1lKCk7XG4gICAgY29uc3QgY29tcGxldGVkUGVyY2VudHMgPSAoY29tcGxldGVkU2VjIC8gZHVyYXRpb25TZWMpICogMTAwO1xuICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucGxheWVyX19wbGF5YmFjay1idXR0b25cIikuc3R5bGUubGVmdCA9IGAke2NvbXBsZXRlZFBlcmNlbnRzfSVgXG5cbiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLnBsYXllcl9fZHVyYXRpb24tY29tcGxldGVkXCIpLmlubmVySFRNTCA9IGZvcm1hdFRpbWUoY29tcGxldGVkU2VjKVxuICB9LCAxMDAwKTtcbn1cblxuZnVuY3Rpb24gZm9ybWF0VGltZSh0aW1lU2VjKSB7XG4gIGNvbnN0IHJvdW5kVGltZSA9IE1hdGgucm91bmQodGltZVNlYyk7XG4gIGNvbnN0IG1pbnV0ZXMgPSBhZGRaZXJvKE1hdGguZmxvb3Iocm91bmRUaW1lIC8gNjApKTtcbiAgY29uc3Qgc2Vjb25kcyA9IGFkZFplcm8ocm91bmRUaW1lIC0gbWludXRlcyAqIDYwKTtcblxuICBmdW5jdGlvbiBhZGRaZXJvKG51bSkge1xuICAgIHJldHVybiBudW0gPCAxMCA/IGAwJHtudW19YDogbnVtO1xuICB9XG5cbiAgcmV0dXJuIGAke21pbnV0ZXN9OiR7c2Vjb25kc31gXG59XG5cbmZ1bmN0aW9uIG9uUGxheWVyU3RhdGVDaGFuZ2UoZXZlbnQpIHtcbiAgLypcbiAgLTEgKNCy0L7RgdC/0YDQvtC40LfQstC10LTQtdC90LjQtSDQstC40LTQtdC+INC90LUg0L3QsNGH0LDRgtC+KVxuICAwICjQstC+0YHQv9GA0L7QuNC30LLQtdC00LXQvdC40LUg0LLQuNC00LXQviDQt9Cw0LLQtdGA0YjQtdC90L4pXG4gIDEgKNCy0L7RgdC/0YDQvtC40LfQstC10LTQtdC90LjQtSlcbiAgMiAo0L/QsNGD0LfQsClcbiAgMyAo0LHRg9GE0LXRgNC40LfQsNGG0LjRjylcbiAgNSAo0LLQuNC00LXQviDQv9C+0LTQsNGO0YIg0YDQtdC/0LvQuNC60LgpLlxuICovXG4gIHN3aXRjaCAoZXZlbnQuZGF0YSl7XG4gICAgY2FzZSAxOlxuICAgICAgcGxheWVyQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoXCJhY3RpdmVcIilcbiAgICAgIHBsYXllckNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKFwicGF1c2VkXCIpXG4gICAgICBcbiAgICAgIGJyZWFrO1xuICAgICAgXG4gICAgICBjYXNlIDI6XG4gICAgICAgIHBsYXllckNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKFwiYWN0aXZlXCIpXG4gICAgICAgIHBsYXllckNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKFwicGF1c2VkXCIpXG4gICAgICBicmVhaztcbiAgfVxufVxuXG5cbmZ1bmN0aW9uIG9uWW91VHViZUlmcmFtZUFQSVJlYWR5KCkge1xuICBwbGF5ZXIgPSBuZXcgWVQuUGxheWVyKCd5dC1wbGF5ZXInLCB7XG4gICAgaGVpZ2h0OiAnMzkwJyxcbiAgICB3aWR0aDogJzY2MCcsXG4gICAgdmlkZW9JZDogJ2w2eU9hbUNUNUJRJyxcbiAgICBldmVudHM6IHtcbiAgICAgICdvblJlYWR5Jzogb25QbGF5ZXJSZWFkeSxcbiAgICAgICdvblN0YXRlQ2hhbmdlJzogb25QbGF5ZXJTdGF0ZUNoYW5nZVxuICAgIH0sXG4gICAgcGxheWVyVmFyczoge1xuICAgICAgY29udHJvbHM6IDAsXG4gICAgICBkaXNhYmxla2I6IDAsXG4gICAgICBzaG93aW5mbzogMCxcbiAgICAgIHJlbDogMCxcbiAgICAgIGF1dG9wbGF5OiAwLFxuICAgICAgbW9kZXN0YnJhbmRpbmc6IDBcbiAgICB9XG4gIH0pO1xufVxuZXZlbnRzSW5pdCgpO1xuIiwiKGZ1bmN0aW9uICgpIHtcbmZ1bmN0aW9uIGdldEJsb2NrQnlBbGlhcyhhbGlhcyl7XG4gIHJldHVybiAkKFwiLnJldmlld3NfX2l0ZW1cIikuZmlsdGVyKChpbmRleCwgaXRlbSkgPT4ge1xuICAgIHJldHVybiAkKGl0ZW0pLmF0dHIoXCJkYXRhLWxpbmtlZC13aXRoXCIpID09IGFsaWFzXG4gIH0pO1xufVxuXG4kKFwiLmludGVyYWN0aXZlLWF2YXRhcl9fbGlua1wiKS5vbihcImNsaWNrXCIsIGUgPT4ge1xuICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgY29uc3QgJHRoaXMgPSAkKGUuY3VycmVudFRhcmdldCk7XG4gIGNvbnN0IHRhcmdldCA9ICR0aGlzLmF0dHIoXCJkYXRhLW9wZW5cIik7XG4gIGNvbnN0IGl0ZW1Ub1Nob3cgPSBnZXRCbG9ja0J5QWxpYXModGFyZ2V0KTtcbiAgY29uc3QgY3VycmVudEl0ZW0gPSAkdGhpcy5jbG9zZXN0KFwiLmludGVyYWN0aXZlLWF2YXRhclwiKTtcblxuICBpdGVtVG9TaG93LmFkZENsYXNzKFwiYWN0aXZlXCIpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoXCJhY3RpdmVcIilcbiAgY3VycmVudEl0ZW0uYWRkQ2xhc3MoXCJhY3RpdmVcIikuc2libGluZ3MoKS5yZW1vdmVDbGFzcyhcImFjdGl2ZVwiKVxufSlcbn0pKCk7IiwiY29uc3Qgc2xpZGVyID0gJCgnLnNsaWRlcl9fbGlzdCcpLmJ4U2xpZGVyKHtcbiAgcGFnZXI6IGZhbHNlLFxuICBjb250cm9sczogZmFsc2Vcbn0pO1xuXG4kKFwiLnNsaWRlcl9fYXJyb3ctLXR5cGUtLXByZXZcIikuY2xpY2soZSA9PiB7XG4gIGUucHJldmVudERlZmF1bHQoKTtcbiAgc2xpZGVyLmdvVG9QcmV2U2xpZGUoKTtcbn0pO1xuXG4kKFwiLnNsaWRlcl9fYXJyb3ctLXR5cGUtLW5leHRcIikuY2xpY2soZSA9PiB7XG4gIGUucHJldmVudERlZmF1bHQoKTtcbiAgc2xpZGVyLmdvVG9OZXh0U2xpZGUoKTtcbn0pOyIsIihmdW5jdGlvbiAoKSB7XG5jb25zdCBlbXBsb3llZUxpc3REZXNrID0gJChcIi50ZWFtX19uYW1lXCIsIFwiLnRlYW1fX2xpc3QtLWRlc2t0b3BcIik7XG5cbmNvbnN0IGVtcGxveWVlTGlzdE1vYmlsZSA9ICQoXCIudGVhbV9fbmFtZVwiLCBcIi50ZWFtX19saXN0LS1tb2JpbGVcIik7XG5cbmZ1bmN0aW9uIGhpZGVBY2NvcmRlb24oZW1wbG95ZWVMaXN0KXtcbiAgZW1wbG95ZWVMaXN0LmVhY2goKGluZGV4LCBlbXBsb3llZSkgPT4ge1xuICAgIGxldCBkZXNjRWxlbSA9ICQoZW1wbG95ZWUpLm5leHQoKTtcbiAgICBkZXNjRWxlbS5oZWlnaHQoMCk7XG4gICAgZGVzY0VsZW0ucmVtb3ZlQ2xhc3MoXCJhY3RpdmVcIik7XG4gICAgJChlbXBsb3llZSkucmVtb3ZlQ2xhc3MoXCJ0ZWFtX19uYW1lLS1hY3RpdmVcIik7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBzaG93QWNjb3JkZW9uKGRlc2NXcmFwRWxlbSwgbmFtZUVsZW0pe1xuICBsZXQgZGVzY0VsZW0gPSBkZXNjV3JhcEVsZW0uZmluZCgnLnRlYW1fX2Rlc2MnKTtcbiAgbGV0IGhlaWdodCA9IGRlc2NFbGVtLmNzcygnaGVpZ2h0Jyk7XG4gIGRlc2NXcmFwRWxlbS5oZWlnaHQoaGVpZ2h0KTtcbiAgbmFtZUVsZW0uYWRkQ2xhc3MoXCJ0ZWFtX19uYW1lLS1hY3RpdmVcIilcbiAgZGVzY1dyYXBFbGVtLmFkZENsYXNzKFwiYWN0aXZlXCIpO1xufVxuXG5mdW5jdGlvbiBpc0Rlc2t0b3AoZWxlbSkge1xuICByZXR1cm4gZWxlbS5jbG9zZXN0KFwiLnRlYW1fX2xpc3QtLWRlc2t0b3BcIikubGVuZ3RoID09IDE7XG59O1xuXG4kKFwiLnRlYW1fX25hbWVcIikub24oXCJjbGlja1wiLCBmdW5jdGlvbiAoKXtcbiAgbGV0IGN1cnJlbnROYW1lID0gJCh0aGlzKTtcbiAgbGV0IGRlc2MgPSBjdXJyZW50TmFtZS5uZXh0KCk7XG5cbiAgaWYgKGRlc2MuaGFzQ2xhc3MoXCJhY3RpdmVcIikpIHtcbiAgICBpZiAoaXNEZXNrdG9wKGN1cnJlbnROYW1lKSl7XG4gICAgICBoaWRlQWNjb3JkZW9uKGVtcGxveWVlTGlzdERlc2spO1xuICAgIH0gZWxzZSB7XG4gICAgICBoaWRlQWNjb3JkZW9uKGVtcGxveWVlTGlzdE1vYmlsZSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGlmIChpc0Rlc2t0b3AoY3VycmVudE5hbWUpKXtcbiAgICAgIGhpZGVBY2NvcmRlb24oZW1wbG95ZWVMaXN0RGVzaylcbiAgICB9IGVsc2Uge1xuICAgICAgaGlkZUFjY29yZGVvbihlbXBsb3llZUxpc3RNb2JpbGUpXG4gICAgfVxuICAgIHNob3dBY2NvcmRlb24oZGVzYywgY3VycmVudE5hbWUpXG4gIH1cblxufSk7XG59KSgpO1xuIl19
